'use client';
import React, { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import {
  Box,
  Typography,
  Paper,
  Button,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  CircularProgress,
  Alert,
  IconButton,
  Chip,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  useTheme,
  useMediaQuery,
  Avatar,
  Accordion,
  AccordionSummary,
  AccordionDetails
} from '@mui/material';
import {
  DirectionsCar as CarIcon,
  DirectionsCar as DirectionsCarIcon,
  CalendarToday as CalendarIcon,
  Clear as ClearIcon,
  ArrowBack as BackIcon,
  Download as DownloadIcon,
  Directions,
  ExpandMore as ExpandMoreIcon
} from '@mui/icons-material';

// Date picker imports
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
import { th } from 'date-fns/locale';

import Layout from '../../../components/Layout';
import { useSnackbar } from '../../../../contexts/SnackbarContext';

// Vehicle type mapping function
const getVehicleTypeLabel = (vehicleType: string): string => {
  switch (vehicleType?.toLowerCase()) {
    case 'truck':
      return 'รถบรรทุก';
    case 'pickup':
      return 'รถกระบะ';
    case 'forklift':
      return 'โฟล์คลิฟท์';
    default:
      return vehicleType || '';
  }
};

interface Vehicle {
  id: number;
  licensePlate: string;
  brand: string;
  model: string;
  vehicleType: string;
  driverName?: string;
  backupDriverName?: string;
  carImage?: string;
}

interface Customer {
  id: number;
  cmName: string;
}

interface TripItem {
  id: number;
  // Optional plain name for backward compatibility
  itemName?: string;
  // Nested item object from API
  item?: {
    id: number;
    ptPart?: string;
    ptDesc1?: string;
    ptUm?: string;
  };
  quantity: number | string;
  unit: string;
  unitPrice?: number | string;
  totalPrice: number | string;
  remark?: string;
}

interface TripRecord {
  id: number;
  departureDate: string;
  returnDate: string;
  departureTime?: string;
  returnTime?: string;
  actualDistance: number | string;
  estimatedDistance?: number | string;
  days: number | string;
  totalAllowance: number | string;
  distanceCheckFee?: number | string; // ค่าเช็คระยะ
  fuelCost?: number | string;         // ค่าน้ำมันรถ
  tollFee?: number | string;          // ค่าทางด่วน
  repairCost?: number | string;       // ค่าซ่อมแซม
  documentNumber?: string;            // เลขที่เอกสาร
  driverType?: string;                // 'main' | 'backup' | 'other'
  driverName?: string;                // ชื่อคนขับที่ใช้ในเที่ยวนี้
  customer: Customer;
  vehicle?: Vehicle;
  tripItems?: TripItem[];
  remark?: string;
}

// Component สำหรับแสดงรูปรถยนต์
const VehicleImage = ({ vehicle, size = 24 }: { vehicle: Vehicle; size?: number }) => {
  return vehicle.carImage ? (
    <Avatar
      src={vehicle.carImage}
      alt={`${vehicle.brand} ${vehicle.model}`}
      sx={{ 
        width: size, 
        height: size, 
        borderRadius: 1.5,
        border: '1px solid',
        borderColor: 'divider'
      }}
      variant="rounded"
      imgProps={{
        loading: 'lazy',
        style: { objectFit: 'cover' }
      }}
    />
  ) : (
    <Box sx={{ 
      width: size, 
      height: size, 
      display: 'flex', 
      alignItems: 'center', 
      justifyContent: 'center',
      bgcolor: 'primary.main',
      borderRadius: 1.5,
      color: 'white'
    }}>
      <CarIcon sx={{ fontSize: size * 0.6 }} />
    </Box>
  );
};

export default function AllVehicleTripReportPage() {
  const router = useRouter();
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));
  const { showSnackbar } = useSnackbar();

  // State management
  const [vehicles, setVehicles] = useState<Vehicle[]>([]);
  const [selectedVehicleId, setSelectedVehicleId] = useState<string>('');
  const [tripRecords, setTripRecords] = useState<TripRecord[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedMonth, setSelectedMonth] = useState<string>('all');
  const [selectedYear, setSelectedYear] = useState<string>(new Date().getFullYear().toString());
  const [isExporting, setIsExporting] = useState(false);
  const minimalRef = useRef<HTMLDivElement | null>(null);

  // Months data
  const months = [
    { value: 'all', label: 'ทั้งหมด' },
    { value: '1', label: 'มกราคม' },
    { value: '2', label: 'กุมภาพันธ์' },
    { value: '3', label: 'มีนาคม' },
    { value: '4', label: 'เมษายน' },
    { value: '5', label: 'พฤษภาคม' },
    { value: '6', label: 'มิถุนายน' },
    { value: '7', label: 'กรกฎาคม' },
    { value: '8', label: 'สิงหาคม' },
    { value: '9', label: 'กันยายน' },
    { value: '10', label: 'ตุลาคม' },
    { value: '11', label: 'พฤศจิกายน' },
    { value: '12', label: 'ธันวาคม' },
  ];

  // Get available years
  const getAvailableYears = () => {
    const currentYear = new Date().getFullYear();
    const years = [];
    for (let year = currentYear; year >= 2025; year--) {
      years.push(year);
    }
    return years;
  };

  // Load vehicles on component mount
  useEffect(() => {
    loadVehicles();
  }, []);

  // Load trip records when filters change
  useEffect(() => {
    if (selectedVehicleId && selectedMonth && selectedYear) {
      loadTripRecords();
    } else {
      setTripRecords([]);
    }
  }, [selectedVehicleId, selectedMonth, selectedYear]);

  const loadVehicles = async () => {
    try {
      const response = await fetch('/api/vehicles?limit=100');
      const result = await response.json();
      
      console.log('Vehicles API Response:', result);
      
      if (result.success && Array.isArray(result.data)) {
        console.log('Found vehicles:', result.data.length, 'vehicles');
        setVehicles(result.data);
      } else if (Array.isArray(result)) {
        console.log('Found vehicles (direct array):', result.length, 'vehicles');
        setVehicles(result);
      } else {
        setVehicles([]);
        showSnackbar('ไม่สามารถโหลดข้อมูลรถได้', 'error');
      }
    } catch (error) {
      console.error('Error loading vehicles:', error);
      setVehicles([]);
      showSnackbar('เกิดข้อผิดพลาดในการโหลดข้อมูลรถ', 'error');
    }
  };

  const loadTripRecords = async () => {
    console.log('Loading trip records with conditions:', {
      selectedVehicleId,
      selectedMonth,
      selectedYear
    });
    
    if (!selectedVehicleId || !selectedMonth || !selectedYear) {
      console.log('Conditions not met for loading trip records');
      setTripRecords([]);
      return;
    }
    
    try {
      setLoading(true);
      const params = new URLSearchParams();
      
      // Calculate month range
      const yearNum = parseInt(selectedYear);
      let startDate, endDate;
      
      if (selectedMonth === 'all') {
        // All months in the selected year
        startDate = new Date(yearNum, 0, 1); // January 1st
        endDate = new Date(yearNum, 11, 31); // December 31st
      } else {
        // Specific month
        const monthNum = parseInt(selectedMonth);
        startDate = new Date(yearNum, monthNum - 1, 1);
        endDate = new Date(yearNum, monthNum, 0); // Last day of the month
      }
      
      params.append('vehicleId', selectedVehicleId);
      params.append('startDate', toYmdLocal(startDate));
      params.append('endDate', toYmdLocal(endDate));
      params.append('limit', '100');

      const apiUrl = `/api/trip-records?${params}`;
      console.log('Fetching trip records:', {
        url: apiUrl,
        selectedVehicleId,
        monthRange: {
          start: { date: startDate, formatted: formatDate(startDate.toISOString()) },
          end: { date: endDate, formatted: formatDate(endDate.toISOString()) }
        }
      });
      
      const response = await fetch(apiUrl);
      const result = await response.json();
      
      console.log('Trip Records API Response:', result);
      
      if (result.trips && Array.isArray(result.trips)) {
        console.log('Found trip records:', result.trips.length, 'trips');
        setTripRecords(result.trips);
      } else if (Array.isArray(result)) {
        console.log('Found trip records (direct array):', result.length, 'trips');
        setTripRecords(result);
      } else {
        console.warn('Trip records data is not in expected format:', result);
        setTripRecords([]);
        showSnackbar('ไม่พบข้อมูลการเดินทาง', 'info');
      }
    } catch (error) {
      console.error('Error loading trip records:', error);
      setTripRecords([]);
      showSnackbar('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
    } finally {
      setLoading(false);
    }
  };

  // Filter handlers
  const handleClearFilters = () => {
    setSelectedVehicleId('');
    setSelectedMonth('all');
    setSelectedYear(new Date().getFullYear().toString());
    setTripRecords([]);
  };

  // Format date - แสดงปี ค.ศ. เพื่อให้สอดคล้องกับ DatePicker
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear(); // ปี ค.ศ.
    return `${day}/${month}/${year}`;
  };

  // Build YYYY-MM-DD in LOCAL time (to avoid UTC shift from toISOString())
  const toYmdLocal = (d: Date) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };

  // Format currency
  const formatCurrency = (amount: number) => {
    return amount.toLocaleString('th-TH', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    });
  };

  // Compute date range label from given trips
  const getTripsDateRangeLabel = (trips: TripRecord[]) => {
    if (!Array.isArray(trips) || trips.length === 0) return '';
    let minDep: Date | null = null;
    let maxRet: Date | null = null;
    for (const t of trips) {
      const dep = new Date(t.departureDate);
      const ret = t.returnDate ? new Date(t.returnDate) : dep;
      if (!minDep || dep < minDep) minDep = dep;
      if (!maxRet || ret > maxRet) maxRet = ret;
    }
    if (!minDep || !maxRet) return '';
    const startStr = minDep.toLocaleDateString('th-TH');
    const endStr = maxRet.toLocaleDateString('th-TH');
    return startStr === endStr ? `วันที่: ${startStr}` : `ช่วงวันที่: ${startStr} - ${endStr}`;
  };

  // Calculate totals (แปลง string เป็น number ก่อนคำนวณ)
  const totalDistance = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const distance = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
    return sum + distance;
  }, 0);
  
  const totalEstimatedDistance = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const distance = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
    return sum + distance;
  }, 0);
  
  const totalAllowance = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const allowance = typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance;
    return sum + allowance;
  }, 0);
  
  const totalDistanceCheckFee = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const fee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
    return sum + fee;
  }, 0);
  
  const totalFuelCost = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const cost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
    return sum + cost;
  }, 0);
  
  const totalTollFee = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const fee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
    return sum + fee;
  }, 0);
  
  const totalRepairCost = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const cost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
    return sum + cost;
  }, 0);
  
  const totalOtherCosts = totalDistanceCheckFee + totalFuelCost + totalTollFee + totalRepairCost;

  
  const totalItemsValue = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const itemsTotal = trip.tripItems?.reduce((itemSum, item) => {
      const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice;
      return itemSum + price;
    }, 0) || 0;
    return sum + itemsTotal;
  }, 0);

  // คำนวณส่วนต่างระยะทาง (รวมแบบเครื่องหมาย + -)
  const totalDistanceDifference = (Array.isArray(tripRecords) ? tripRecords : []).reduce((sum, trip) => {
    const actual = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
    const estimated = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
    return sum + (actual - estimated);
  }, 0);

  const totalCosts = totalAllowance + totalOtherCosts + totalItemsValue;  

  // สร้างรายการรถที่ไม่ซ้ำจาก trip records
  const uniqueVehicles: Vehicle[] = Array.isArray(tripRecords) ? Array.from(
    tripRecords
      .filter(trip => trip.vehicle)
      .reduce((map, trip) => {
        if (trip.vehicle) {
          map.set(trip.vehicle.id, trip.vehicle);
        }
        return map;
      }, new Map<number, Vehicle>())
      .values()
  ) : [];  


  // รวมรายการพัสดุต่อรถ (รวมทุกเที่ยวรถของรถนั้น ๆ)
  const aggregateItems = (trips: TripRecord[]) => {
    type Agg = { name: string; unit?: string; quantity: number; totalPrice: number };
    const map = new Map<string, Agg>();
    trips.forEach(trip => {
      (trip.tripItems || []).forEach((it: any) => {
        const key = it?.item?.id?.toString() || it?.id?.toString() || it?.itemName || Math.random().toString();
        const name = it?.item?.ptDesc1 || it?.itemName || it?.item?.ptPart || 'ไม่ระบุ';
        const unit = it?.unit || it?.item?.ptUm;
        const qty = typeof it?.quantity === 'string' ? (parseFloat(it.quantity) || 0) : (it?.quantity || 0);
        const total = typeof it?.totalPrice === 'string' ? (parseFloat(it.totalPrice) || 0) : (it?.totalPrice || 0);
        const uPrice = typeof it?.unitPrice === 'string' ? (parseFloat(it.unitPrice) || 0) : (it?.unitPrice || 0);
        const priceToAdd = total > 0 ? total : (uPrice && qty ? uPrice * qty : 0);
        const prev = map.get(key);
        if (prev) {
          prev.quantity += qty;
          prev.totalPrice += priceToAdd;
        } else {
          map.set(key, { name, unit, quantity: qty, totalPrice: priceToAdd });
        }
      });
    });
    return Array.from(map.values()).sort((a, b) => b.totalPrice - a.totalPrice);
  };

  // รวมรายการพัสดุแบบแยกต่อลูกค้าและรายการพัสดุ
  const aggregateItemsByCustomer = (trips: TripRecord[]) => {
    type Row = { customerId: number; customerName: string; name: string; unit?: string; quantity: number; totalPrice: number };
    const map = new Map<string, Row>();
    trips.forEach((trip: any) => {
      const cId = trip?.customer?.id;
      const cName = trip?.customer?.cmName || 'ไม่ระบุลูกค้า';
      (trip?.tripItems || []).forEach((it: any) => {
        const itemKey = it?.item?.id?.toString() || it?.id?.toString() || it?.itemName || '';
        const key = `${cId || 'x'}::${itemKey || it?.itemName || Math.random().toString()}`;
        const name = it?.item?.ptDesc1 || it?.itemName || it?.item?.ptPart || 'ไม่ระบุ';
        const unit = it?.unit || it?.item?.ptUm;
        const qty = typeof it?.quantity === 'string' ? (parseFloat(it.quantity) || 0) : (it?.quantity || 0);
        const total = typeof it?.totalPrice === 'string' ? (parseFloat(it.totalPrice) || 0) : (it?.totalPrice || 0);
        const uPrice = typeof it?.unitPrice === 'string' ? (parseFloat(it.unitPrice) || 0) : (it?.unitPrice || 0);
        const priceToAdd = total > 0 ? total : (uPrice && qty ? uPrice * qty : 0);
        const prev = map.get(key);
        if (prev) {
          prev.quantity += qty;
          prev.totalPrice += priceToAdd;
        } else {
          map.set(key, { customerId: cId || 0, customerName: cName, name, unit, quantity: qty, totalPrice: priceToAdd });
        }
      });
    });
    return Array.from(map.values()).sort((a, b) => {
      if (a.customerName === b.customerName) return b.totalPrice - a.totalPrice;
      return a.customerName.localeCompare(b.customerName, 'th');
    });
  };

  // รวมคนขับที่ใช้ในแต่ละรถจากการเดินทาง
  const getVehicleDrivers = (vehicleId: number, trips: TripRecord[]) => {
    const vehicleTrips = trips.filter(trip => trip.vehicle?.id === vehicleId);
    const driversSet = new Set<string>();
    
    vehicleTrips.forEach(trip => {
      if (trip.driverName) {
        driversSet.add(trip.driverName);
      }
    });
    
    // ถ้าไม่มีคนขับจากการเดินทาง ให้ใช้คนขับที่ผูกกับรถ
    if (driversSet.size === 0) {
      const vehicle = trips.find(trip => trip.vehicle?.id === vehicleId)?.vehicle;
      if (vehicle?.driverName) {
        driversSet.add(vehicle.driverName);
      }
      if (vehicle?.backupDriverName) {
        driversSet.add(vehicle.backupDriverName);
      }
    }
    
    return Array.from(driversSet);
  };

  // รวมคนขับที่ไปหาลูกค้าแต่ละราย
  const getCustomerDrivers = (customerTrips: TripRecord[]) => {
    const driversSet = new Set<string>();
    
    customerTrips.forEach(trip => {
      if (trip.driverName) {
        driversSet.add(trip.driverName);
      } else if (trip.vehicle) {
        // ถ้าไม่มีข้อมูลคนขับในการเดินทาง ให้ใช้คนขับที่ผูกกับรถ
        if (trip.vehicle.driverName) {
          driversSet.add(trip.vehicle.driverName);
        }
      }
    });
    
    return Array.from(driversSet);
  };

  // จัดกลุ่มเที่ยวรถต่อลูกค้า
  const groupTripsByCustomer = (trips: TripRecord[]) => {
    const groups: Record<string, TripRecord[]> = {};
    trips.forEach((t) => {
      const key = `${t.customer?.id || 0}::${t.customer?.cmName || 'ไม่ระบุลูกค้า'}`;
      (groups[key] ||= []).push(t);
    });
    return groups; // keys like "<id>::<name>"
  };

  // จัดกลุ่มลูกค้าตาม departure date - return date
  const groupCustomersByDateRange = (trips: TripRecord[]) => {
    const dateGroups: Record<string, Record<string, TripRecord[]>> = {};
    
    trips.forEach((trip) => {
      const depDate = new Date(trip.departureDate);
      const retDate = trip.returnDate ? new Date(trip.returnDate) : depDate;
      
      // สร้าง key สำหรับ date range
      const depDateStr = depDate.toLocaleDateString('th-TH', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
      });
      const retDateStr = retDate.toLocaleDateString('th-TH', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
      });
      
      const dateRangeKey = depDateStr === retDateStr ? 
        depDateStr : 
        `${depDateStr} - ${retDateStr}`;

      // สร้าง key สำหรับลูกค้า
      const customerKey = `${trip.customer?.id || 0}::${trip.customer?.cmName || 'ไม่ระบุลูกค้า'}`;
      
      // จัดกลุ่มตาม date range และ customer
      if (!dateGroups[dateRangeKey]) {
        dateGroups[dateRangeKey] = {};
      }
      if (!dateGroups[dateRangeKey][customerKey]) {
        dateGroups[dateRangeKey][customerKey] = [];
      }
      dateGroups[dateRangeKey][customerKey].push(trip);
    });
    
    return dateGroups;
  };

  // ดึงรายการพัสดุแบบรวมของลูกค้าเดียวจากกลุ่มทั้งหมด
  const getItemsForCustomer = (trips: TripRecord[], customerKey: string) => {
    const [idStr, name] = customerKey.split('::');
    const cid = parseInt(idStr || '0');
    const all = aggregateItemsByCustomer(trips);
    return all.filter(r => r.customerId === cid);
  };

  // Export to PDF using professional report format (clean layout without UI elements)
  // Export to PDF (Minimal Thai) using hidden HTML template + html2canvas
  const exportToPDF = async () => {
    if (!selectedVehicleId || !tripRecords || tripRecords.length === 0) {
      showSnackbar('กรุณาเลือกรถหรือเลือกช่วงวันที่และตรวจสอบว่ามีข้อมูลการเดินทาง', 'warning');
      return;
    }
    try {
      setIsExporting(true);

      const { default: jsPDF } = await import('jspdf');
      const { default: html2canvas } = await import('html2canvas');

      // ใช้เทมเพลต HTML ที่ซ่อนอยู่เพื่อให้ render ภาษาไทยถูกต้อง
      const sourceEl = minimalRef.current;
      if (!sourceEl) {
        showSnackbar('ไม่พบเทมเพลตสำหรับสร้าง PDF', 'error');
        return;
      }

      // ทำให้มองเห็นชั่วคราวนอกหน้าจอ เพื่อให้ layout คำนวณได้ถูกต้อง
      const prevVisibility = sourceEl.style.visibility;
      const prevPosition = sourceEl.style.position;
      const prevLeft = sourceEl.style.left;
      const prevTop = sourceEl.style.top;
      const prevWidth = sourceEl.style.width;

      sourceEl.style.visibility = 'visible';
      sourceEl.style.position = 'absolute';
      sourceEl.style.left = '-9999px';
      sourceEl.style.top = '0';
      sourceEl.style.width = '900px';

      // รอ font face
      await document.fonts.ready;

      const canvas = await html2canvas(sourceEl, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff'
      });

      // คืนค่า style เดิม
      sourceEl.style.visibility = prevVisibility;
      sourceEl.style.position = prevPosition;
      sourceEl.style.left = prevLeft;
      sourceEl.style.top = prevTop;
      sourceEl.style.width = prevWidth;

      const imgData = canvas.toDataURL('image/png');
      const doc = new jsPDF('p', 'mm', 'a4');

      const pageWidth = 210;
      const pageHeight = 297;
      const margin = 10;
      const contentWidth = pageWidth - margin * 2;
      const imgHeight = (canvas.height * contentWidth) / canvas.width;
      const contentHeight = pageHeight - margin * 2 - 12; // เผื่อ footer

      const totalPages = Math.ceil(imgHeight / contentHeight);
      let renderedHeight = 0;

      for (let page = 1; page <= totalPages; page++) {
        if (page > 1) doc.addPage();

        const sX = 0;
        const sY = (renderedHeight / imgHeight) * canvas.height;
        const sW = canvas.width;
        const sH = Math.min((contentHeight / imgHeight) * canvas.height, canvas.height - sY);

        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = sW;
        pageCanvas.height = sH;
        const pctx = pageCanvas.getContext('2d');
        if (pctx) {
          pctx.drawImage(canvas, sX, sY, sW, sH, 0, 0, sW, sH);
        }
        const pageImg = pageCanvas.toDataURL('image/png');
        const drawHeight = (sH * contentWidth) / sW;

        doc.addImage(pageImg, 'PNG', margin, margin, contentWidth, drawHeight);

        // footer
        doc.setFontSize(8);
        doc.text(`Print Date: ${new Date().toLocaleString('th-TH')}`, margin, pageHeight - 6);
        doc.text(`Page ${page}/${totalPages}`, pageWidth - margin, pageHeight - 6, { align: 'right' });

        renderedHeight += contentHeight;
      }

      const today = new Date().toISOString().split('T')[0];
      const fileName = `trip-report-${today}.pdf`;
      
      // Create blob and download using standard approach to avoid browser security warnings
      const pdfBlob = doc.output('blob');
      const blobUrl = URL.createObjectURL(pdfBlob);
      
      // Create temporary download link
      const downloadLink = document.createElement('a');
      downloadLink.href = blobUrl;
      downloadLink.download = fileName;
      downloadLink.style.display = 'none';
      
      // Trigger download
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
      
      // Clean up blob URL
      setTimeout(() => {
        URL.revokeObjectURL(blobUrl);
      }, 100);
      
      showSnackbar('ดาวน์โหลด PDF เรียบร้อยแล้ว', 'success');
    } catch (e) {
      console.error(e);
      showSnackbar('เกิดข้อผิดพลาดในการสร้าง PDF', 'error');
    } finally {
      setIsExporting(false);
    }
  };

  // Export PDF สำหรับข้อมูลสรุปรถทั้งหมด
  // This function is no longer needed as we only support single vehicle selection
  // const exportAllVehiclesSummaryToPDF was removed

  return (
    <LocalizationProvider dateAdapter={AdapterDateFns} adapterLocale={th}>
    <Layout showSidebar={false}>
      <Box data-print-content sx={{
        '@media print': {
          fontSize: '12px',
          lineHeight: 1.2,
          margin: '0 !important',
          padding: '0 !important',
          '@page': {
            margin: '10mm',
            size: 'A4',
          },
          '& .MuiPaper-root': {
            boxShadow: 'none !important',
            border: '1px solid #000 !important',
            margin: '2px 0 !important',
            padding: '4px !important',
            borderRadius: '0 !important',
            backgroundColor: '#fff !important',
          },
          '& .MuiTypography-h6': {
            fontSize: '12px !important',
            margin: '2px 0 !important',
            lineHeight: 1.1,
            color: '#000 !important',
          },
          '& .MuiTypography-body2': {
            fontSize: '9px !important',
            lineHeight: 1.1,
            margin: '1px 0 !important',
            color: '#000 !important',
          },
          '& .MuiTypography-caption': {
            fontSize: '7px !important',
            lineHeight: 1,
            color: '#000 !important',
          },
          '& .MuiBox-root': {
            margin: '2px 0 !important',
            padding: '2px !important',
          },
          '& .MuiTableCell-root': {
            padding: '1px 2px !important',
            fontSize: '8px !important',
            borderBottom: '1px solid #000 !important',
            lineHeight: 1.1,
            backgroundColor: '#fff !important',
            color: '#000 !important',
          },
          '& .MuiTableHead-root .MuiTableCell-root': {
            fontSize: '7px !important',
            fontWeight: 'bold !important',
            backgroundColor: '#fff !important',
            padding: '2px !important',
            color: '#000 !important',
          },
          // Remove all visual decorations for print
          '& .MuiSvgIcon-root': {
            display: 'none !important',
          },
          // Simplify all borders for print
          '& *': {
            backgroundColor: '#fff !important',
            color: '#000 !important',
          },
          gap: '2px !important',
          // Fixed width columns for PDF
          '& .three-column-summary': {
            display: 'table !important',
            width: '100% !important',
            tableLayout: 'fixed !important',
            borderCollapse: 'separate !important',
            borderSpacing: '8px !important',
          },
          '& .column-cell': {
            display: 'table-cell !important',
            width: '33.333% !important',
            verticalAlign: 'top !important',
            border: 'none !important',
            padding: '0 !important',
            boxSizing: 'border-box !important',
          },
          // Override any flex layout in columns
          '& .column-content': {
            width: '100% !important',
            boxSizing: 'border-box !important',
            display: 'block !important',
          },
        }
      }}>
        {/* Hidden Minimal PDF Template (Thai-friendly) */}
        <Box
          ref={minimalRef}
          sx={{
            visibility: 'hidden',
            position: 'absolute',
            left: '-9999px',
            top: 0,
            width: 860,
            backgroundColor: '#fff',
            color: '#000',
            fontFamily: `'Sarabun', Arial, sans-serif`,
            '& h1, & h2, & h3': { fontWeight: 700, margin: 0, color: '#000' },
            '& .section': { marginBottom: '6px' },
            '& .row': { display: 'flex', gap: '8px', alignItems: 'center' },
            '& .table': { width: '100%', borderCollapse: 'collapse' },
            '& .table th, & .table td': { padding: '3px', fontSize: '13px', lineHeight: 1.2 },
            '& .table th': { background: '#fff', fontWeight: 700, textAlign: 'center' },
            '& .table td': { background: '#fff' },
          }}
        >
          <Box className="section">
            <Typography component="h2" sx={{ fontSize: 18, fontWeight: 700 , fontFamily: `'Sarabun', Arial, sans-serif`,textAlign:'center' }}>
              รายงานบันทึกการเดินทาง
            </Typography>
            <Typography sx={{ fontSize: 16 , fontWeight: 500 , fontFamily: `'Sarabun', Arial, sans-serif`, whiteSpace: 'pre-line' , textAlign:'center' }}>
              {selectedVehicleId && selectedMonth && selectedYear
                ? (() => {
                    const v = (Array.isArray(vehicles) ? vehicles : []).find(v => v.id.toString() === selectedVehicleId);
                    if (!v) return '';
                    const monthName = months.find(m => m.value === selectedMonth)?.label || selectedMonth;
                    const yearDisplay = parseInt(selectedYear) + 543;
                    return `${monthName} ${yearDisplay}\nรถ: ${v.licensePlate} - ${v.brand} ${v.model} (${getVehicleTypeLabel(v.vehicleType)}) | คนขับ: ${getVehicleDrivers(v.id, tripRecords).join(', ')} | จำนวนรอบ: ${tripRecords?.length || 0} เที่ยว`;
                  })()
                : ''}
            </Typography>
          </Box>

          {/* Summary */}
          <Box className="section">
            <table className="table" style={{ fontSize: '14px' , width:'500px' , margin: '0 auto' }}>
              <thead>
                <tr>
                  <th>ระยะทางจริง (กม.)</th>
                  <th>ระยะทางระบบ (กม.)</th>
                  <th>ส่วนต่าง (กม.)</th>
                  
                </tr>
              </thead>
              <tbody>
                <tr style={{ textAlign: 'center' }}>
                  <td>{Math.round(totalDistance)}</td>
                  <td>{Math.round(totalEstimatedDistance)}</td>
                  <td>{Math.round(totalDistanceDifference)}</td>
                  
                </tr>
              </tbody>
            </table>
          </Box>

          {/* Data by single vehicle - New Layout Style */}
          {selectedVehicleId && tripRecords && tripRecords.length > 0 ? (
            uniqueVehicles.map(vehicle => {
              const vehicleTrips = tripRecords.filter(trip => trip.vehicle?.id === vehicle.id);
              if (vehicleTrips.length === 0) return null;
              return (
                <Box key={vehicle.id} className="section" style={{ marginBottom: '8px' , marginTop: '8px' }}>

                  {(() => {
                    const dateGroups = groupCustomersByDateRange(vehicleTrips);
                    const itemRows = aggregateItemsByCustomer(vehicleTrips);
                    const vehicleGrandTotal = itemRows.reduce((s, r) => s + (r.totalPrice || 0), 0);
                    
                    return (
                      <>
                        {/* Vehicle Header - Compact */
                        // Always show a date line for this vehicle: if user selected a range, show that; otherwise derive from trips
                        }
                        <table style={{ 
                          width: '100%', 
                          borderCollapse: 'collapse',
                          fontSize: '14px',
                          marginBottom: '3px'
                        }}>
                          <thead>
                            {/* Vehicle date range header row */}
                            <tr>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '11%'
                              }}>วันที่ไป-กลับ</th>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '15%'
                              }}>ลูกค้า</th>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '10%'
                              }}>คนขับ</th>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '9%'
                              }}>เลขที่เอกสาร</th>
                              
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '12%'
                              }}>ระยะทาง</th>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '7%'
                              }}>เบี้ยเลี้ยง</th>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '22%'
                              }}>พัสดุที่นำกลับ</th>
                              <th style={{ 
                                border: '1px solid #000',
                                padding: '2px',
                                textAlign: 'center',
                                fontWeight: 700,
                                width: '13%'
                              }}>ค่าใช้จ่าย</th>
                              
                            </tr>
                          </thead>
                          <tbody>
                            {Object.keys(dateGroups).sort().map((dateRangeKey) => {
                              const customerGroups = dateGroups[dateRangeKey];
                              
                              return Object.keys(customerGroups).map((customerKey, customerIndex) => {
                                const list = customerGroups[customerKey];
                                const customerName = customerKey.split('::')[1] || 'ไม่ระบุลูกค้า';
                                
                                // Get document numbers for this customer
                                const documentNumbers = list.filter(t => t.documentNumber && t.documentNumber.trim()).map(t => t.documentNumber);
                                const uniqueDocNumbers = [...new Set(documentNumbers)];
                                const docNumberText = uniqueDocNumbers.length > 0 ? uniqueDocNumbers.join(', ') : '-';
                                
                                // Calculate customer totals
                                const totalActualDist = list.reduce((sum, trip) => {
                                  const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                                  return sum + actualDist;
                                }, 0);
                                const totalEstimatedDist = list.reduce((sum, trip) => {
                                  const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                  return sum + estimatedDist;
                                }, 0);
                                const totalAllowance = list.reduce((sum, trip) => sum + (typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance), 0);
                                
                                // Get items and expenses for this customer
                                const cid = customerKey.split('::')[0];
                                const customerItems = itemRows.filter(r => r.customerId === parseInt(cid || '0'));
                                
                                // Calculate expenses
                                const totalDistanceCheckFee = list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0);
                                const totalFuelCost = list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0);
                                const totalTollFee = list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0);
                                const totalRepairCost = list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0);
                                const totalExpenses = totalDistanceCheckFee + totalFuelCost + totalTollFee + totalRepairCost;
                                
                                // Calculate total signed difference by summing individual trip differences with sign
                                const totalAbsoluteDifference = list.reduce((sum, trip) => {
                                  const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                                  const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                  return sum + (actualDist - estimatedDist);
                                }, 0);
                                                                
                                return (
                                  <React.Fragment key={`${dateRangeKey}-${customerKey}`}>
                                    {/* Display date range in first column only for first customer in each date group */}
                                    <tr>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center',
                                        fontWeight: 700,
                                        
                                      }}>
                                        {customerIndex === 0 ? (
                                          <div style={{ fontSize: '12px', fontWeight: 700 }}>{dateRangeKey}</div>
                                        ) : null}
                                      </td>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center',
                                        fontWeight: 600
                                      }}>
                                        <div style={{ fontSize: '12px', fontWeight: 700 }}>{customerName}</div>
                                      </td>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center',
                                        fontWeight: 600
                                      }}>
                                        <div style={{ fontSize: '12px', fontWeight: 700 }}>
                                          {(() => {
                                            const drivers = getCustomerDrivers(list);
                                            return drivers.length > 0 ? drivers.join(', ') : 'ไม่ระบุ';
                                          })()}
                                        </div>
                                      </td>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center'
                                      }}>
                                        <div style={{ fontSize: '12px', fontWeight: 700 }}>{docNumberText}</div>
                                      </td>
                                      
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center'
                                      }}>
                                        <div style={{ fontSize: '12px' }}>จริง: {Math.round(totalActualDist)}</div>
                                        <div style={{ fontSize: '12px' }}>ประมาณ: {Math.round(totalEstimatedDist)}</div>
                                        
                                        <div style={{ fontSize: '12px', fontWeight: 700 }}>
                                          ต่าง: {totalAbsoluteDifference >= 0 ? '+' : ''}{Math.round(totalAbsoluteDifference)} กม
                                        </div>
                                      </td>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center'
                                      }}>
                                        <div style={{ fontSize: '12px', fontWeight: 700 }}>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</div>
                                      </td>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '2px',
                                        textAlign: 'center',
                                        fontSize: '12px'
                                      }}>
                                        {customerItems.length > 0 ? (
                                          <div>
                                            {customerItems.map((item, idx) => (
                                              <div key={idx} style={{ marginBottom: '1px' }}>
                                                <strong>{item.name}</strong> {Number(item.quantity).toLocaleString('th-TH')}{item.unit || ''} = ฿{Math.round(item.totalPrice).toLocaleString('th-TH')}
                                              </div>
                                            ))}
                                            <div style={{ fontWeight: 700, marginTop: '1px', borderTop: '1px solid #ddd', paddingTop: '1px' }}>
                                              รวม: ฿{customerItems.reduce((s, r) => s + (r.totalPrice || 0), 0).toLocaleString('th-TH')}
                                            </div>
                                          </div>
                                        ) : '-'}
                                      </td>
                                      <td style={{ 
                                        border: '1px solid #000',
                                        padding: '5px',
                                        textAlign: 'center',
                                        fontSize: '12px'
                                      }}>
                                        {totalExpenses > 0 ? (
                                          <div>
                                            {totalDistanceCheckFee > 0 && <div>เช็คระยะ: ฿{Math.round(totalDistanceCheckFee).toLocaleString('th-TH')}</div>}
                                            {totalFuelCost > 0 && <div>น้ำมัน: ฿{Math.round(totalFuelCost).toLocaleString('th-TH')}</div>}
                                            {totalTollFee > 0 && <div>ทางด่วน: ฿{Math.round(totalTollFee).toLocaleString('th-TH')}</div>}
                                            {totalRepairCost > 0 && <div>ซ่อมแซม: ฿{Math.round(totalRepairCost).toLocaleString('th-TH')}</div>}
                                            <div style={{ fontWeight: 700, marginTop: '1px', borderTop: '1px solid #ddd', paddingTop: '1px' }}>
                                              รวม: ฿{Math.round(totalExpenses).toLocaleString('th-TH')}
                                            </div>
                                          </div>
                                        ) : '-'}
                                      </td>

                                    </tr>
                                  </React.Fragment>
                                );
                              });
                            })}
                          </tbody>
                          <tfoot>
                            <tr>
                              <td colSpan={5} style={{ 
                                border: '1px solid #000',
                                padding: '4px',
                                textAlign: 'right',
                                fontWeight: 700,
                                fontSize: '13px',
                                
                              }}>รวมทั้งหมด:</td>
                              <td style={{ 
                                border: '1px solid #000',
                                padding: '4px',
                                textAlign: 'center',
                                fontWeight: 700,
                                fontSize: '13px',
                                
                              }}>
                                ฿{(() => {
                                  const totalAllowance = vehicleTrips.reduce((sum, trip) => {
                                    const allowance = typeof trip.totalAllowance === 'string' 
                                      ? parseFloat(trip.totalAllowance) || 0 
                                      : trip.totalAllowance || 0;
                                    return sum + allowance;
                                  }, 0);
                                  return Math.round(totalAllowance).toLocaleString('th-TH');
                                })()}
                              </td>
                              <td style={{ 
                                border: '1px solid #000',
                                padding: '4px',
                                textAlign: 'center',
                                fontWeight: 700,
                                fontSize: '13px',
                                
                              }}>
                                ฿{(() => {
                                  const totalItems = vehicleTrips.reduce((sum, trip) => {
                                    const itemsTotal = trip.tripItems?.reduce((itemSum: number, item: any) => {
                                      const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice;
                                      return itemSum + price;
                                    }, 0) || 0;
                                    return sum + itemsTotal;
                                  }, 0);
                                  return Math.round(totalItems).toLocaleString('th-TH');
                                })()}
                              </td>
                              <td style={{ 
                                border: '1px solid #000',
                                padding: '4px',
                                textAlign: 'center',
                                fontWeight: 700,
                                fontSize: '13px',
                                
                              }}>
                                ฿{(() => {
                                  const totalExpenses = vehicleTrips.reduce((sum, trip) => {
                                    const distanceCheckFee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                                    const fuelCost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                                    const tollFee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                                    const repairCost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                                    return sum + distanceCheckFee + fuelCost + tollFee + repairCost;
                                  }, 0);
                                  return Math.round(totalExpenses).toLocaleString('th-TH');
                                })()}
                              </td>
                            </tr>
                          </tfoot>
                        </table>
                        
                        {/* Vehicle Summary - Detailed */}
                        <div style={{ 
                          
                          padding: '4px', 
                          fontSize: '12px',
                          marginTop: '2px',
                          backgroundColor: '#f9f9f9'
                        }}>
                          {(() => {
                            // Calculate total products/services value
                            const vehicleProducts = vehicleTrips.reduce((sum, trip) => {
                              const itemsTotal = trip.tripItems?.reduce((itemSum: number, item: any) => {
                                const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice;
                                return itemSum + price;
                              }, 0) || 0;
                              return sum + itemsTotal;
                            }, 0);

                            // Calculate total other expenses for this vehicle
                            const vehicleExpenses = vehicleTrips.reduce((sum, trip) => {
                              const distanceCheckFee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                              const fuelCost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                              const tollFee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                              const repairCost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                              return sum + distanceCheckFee + fuelCost + tollFee + repairCost;
                            }, 0);

                            // Calculate item categories breakdown with quantities
                            const itemCategories = new Map();
                            vehicleTrips.forEach(trip => {
                              trip.tripItems?.forEach((item: any) => {
                                const name = item?.item?.ptDesc1 || item?.itemName || item?.item?.ptPart || 'พัสดุอื่นๆ';
                                const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice || 0;
                                const qty = typeof item.quantity === 'string' ? parseFloat(item.quantity) || 0 : item.quantity || 0;
                                const unit = item?.unit || item?.item?.ptUm || 'หน่วย';
                                
                                const existing = itemCategories.get(name) || { total: 0, qty: 0, unit: unit };
                                itemCategories.set(name, {
                                  total: existing.total + price,
                                  qty: existing.qty + qty,
                                  unit: unit
                                });
                              });
                            });

                            // Calculate expense categories breakdown
                            const expenseCategories = new Map();
                            vehicleTrips.forEach(trip => {
                              const distanceCheckFee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                              const fuelCost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                              const tollFee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                              const repairCost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                              
                              if (distanceCheckFee > 0) expenseCategories.set('ค่าเช็คระยะ', (expenseCategories.get('ค่าเช็คระยะ') || 0) + distanceCheckFee);
                              if (fuelCost > 0) expenseCategories.set('ค่าน้ำมัน', (expenseCategories.get('ค่าน้ำมัน') || 0) + fuelCost);
                              if (tollFee > 0) expenseCategories.set('ค่าทางด่วน', (expenseCategories.get('ค่าทางด่วน') || 0) + tollFee);
                              if (repairCost > 0) expenseCategories.set('ค่าซ่อมแซม', (expenseCategories.get('ค่าซ่อมแซม') || 0) + repairCost);
                            });

                            return (
                              <div style={{ display: 'flex', gap: '8px', alignItems: 'stretch' }}>
                                
                                {/* Column 1 - Products/Services */}
                                <div style={{ flex: '1', display: 'flex', flexDirection: 'column' }}>
                                  <div style={{ fontWeight: 700, marginBottom: '12px' }}></div>
                                  
                                  {/* Products/Services Breakdown */}
                                  <div style={{ marginBottom: '8px', flex: '1' }}>
                                    <div style={{ 
                                      fontWeight: 600, 
                                      fontSize: '12px', 
                                      marginBottom: '4px',
                                      paddingBottom: '2px',
                                      borderBottom: '1px solid #eee'
                                    }}>พัสดุที่นำกลับ:</div>
                                    {Array.from(itemCategories.entries()).length > 0 ? (
                                      Array.from(itemCategories.entries()).map(([name, data]) => (
                                        <div key={name} style={{ 
                                          fontSize: '12px', 
                                          marginLeft: '6px', 
                                          marginBottom: '2px',
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center',
                                          paddingRight: '4px'
                                        }}>
                                          <span style={{ flex: 1 }}>• {name} ({Math.round(data.qty).toLocaleString('th-TH')} {data.unit})</span>
                                          <span style={{ fontWeight: 600, minWidth: '60px', textAlign: 'right' }}>฿{Math.round(data.total).toLocaleString('th-TH')}</span>
                                        </div>
                                      ))
                                    ) : (
                                      <div style={{ 
                                        fontSize: '12px', 
                                        marginLeft: '6px', 
                                        marginBottom: '2px',
                                        color: '#666',
                                        fontStyle: 'italic'
                                      }}>
                                        ไม่มีพัสดุที่นำกลับ
                                      </div>
                                    )}
                                    <div style={{ 
                                      fontSize: '12px', 
                                      fontWeight: 700, 
                                      marginLeft: '6px', 
                                      borderTop: '1px solid #ccc', 
                                      paddingTop: '3px', 
                                      marginTop: '4px',
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      alignItems: 'center',
                                      paddingRight: '4px',
                                      backgroundColor: '#f8f8f8',
                                      padding: '3px 4px'
                                    }}>
                                      <span>รวมพัสดุที่นำกลับ:</span>
                                      <span style={{ minWidth: '60px', textAlign: 'right' }}>฿{Math.round(vehicleProducts).toLocaleString('th-TH')}</span>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Column 2 - Expenses and Total */}
                                <div style={{ flex: '1', display: 'flex', flexDirection: 'column' }}>
                                  <div style={{ fontWeight: 700, marginBottom: '12px' }}></div>
                                  
                                  {/* Combined Expenses and Summary */}
                                  <div style={{ marginBottom: '8px', flex: '1', display: 'flex', flexDirection: 'column', justifyContent: 'space-between' }}>
                                    <div style={{ display: 'flex', gap: '16px' }}>
                                      {/* Left: Expenses Breakdown */}
                                      <div style={{ flex: '1' }}>
                                        <div style={{ 
                                          fontWeight: 600, 
                                          fontSize: '12px', 
                                          marginBottom: '4px',
                                          paddingBottom: '2px',
                                          borderBottom: '1px solid #eee'
                                        }}>ค่าใช้จ่ายอื่น ๆ:</div>
                                        {Array.from(expenseCategories.entries()).length > 0 ? (
                                          Array.from(expenseCategories.entries()).map(([name, total]) => (
                                            <div key={name} style={{ 
                                              fontSize: '12px', 
                                              marginLeft: '6px', 
                                              marginBottom: '2px',
                                              display: 'flex',
                                              justifyContent: 'space-between',
                                              alignItems: 'center',
                                              paddingRight: '4px'
                                            }}>
                                              <span style={{ flex: 1 }}>• {name}</span>
                                              <span style={{ fontWeight: 600, minWidth: '60px', textAlign: 'right' }}>฿{Math.round(total).toLocaleString('th-TH')}</span>
                                            </div>
                                          ))
                                        ) : (
                                          <div style={{ 
                                            fontSize: '12px', 
                                            marginLeft: '6px', 
                                            marginBottom: '2px',
                                            color: '#666',
                                            fontStyle: 'italic'
                                          }}>
                                            ไม่มีค่าใช้จ่ายอื่น ๆ
                                          </div>
                                        )}
                                        <div style={{ 
                                          fontSize: '12px', 
                                          fontWeight: 700, 
                                          marginLeft: '6px', 
                                          borderTop: '1px solid #ccc', 
                                          paddingTop: '3px', 
                                          marginTop: '4px',
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center',
                                          paddingRight: '4px',
                                          backgroundColor: '#f8f8f8',
                                          padding: '3px 4px'
                                        }}>
                                          <span>รวมค่าใช้จ่าย:</span>
                                          <span style={{ minWidth: '60px', textAlign: 'right' }}>฿{Math.round(vehicleExpenses).toLocaleString('th-TH')}</span>
                                        </div>
                                      </div>

                                      {/* Right: Grand Total Section */}
                                      <div style={{ flex: '1' }}>
                                        {(() => {
                                          // Calculate total allowance for this vehicle
                                          const totalAllowance = vehicleTrips.reduce((sum, trip) => {
                                            const allowance = typeof trip.totalAllowance === 'string' 
                                              ? parseFloat(trip.totalAllowance) || 0 
                                              : trip.totalAllowance || 0;
                                            return sum + allowance;
                                          }, 0);

                                          const grandTotal = vehicleProducts + vehicleExpenses + totalAllowance;

                                          return (
                                            <div>
                                              <div style={{ 
                                                fontWeight: 600, 
                                                fontSize: '12px', 
                                                marginBottom: '4px',
                                                paddingBottom: '2px',
                                                borderBottom: '1px solid #eee'
                                              }}>สรุปยอดรวม:</div>
                                              
                                              <div style={{ 
                                                fontSize: '12px', 
                                                marginLeft: '6px', 
                                                marginBottom: '2px',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                paddingRight: '4px'
                                              }}>
                                                <span style={{ flex: 1 }}>• เบี้ยเลี้ยง</span>
                                                <span style={{ fontWeight: 600, minWidth: '60px', textAlign: 'right' }}>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</span>
                                              </div>
                                              
                                              <div style={{ 
                                                fontSize: '12px', 
                                                marginLeft: '6px', 
                                                marginBottom: '2px',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                paddingRight: '4px'
                                              }}>
                                                <span style={{ flex: 1 }}>• พัสดุที่นำกลับ</span>
                                                <span style={{ fontWeight: 600, minWidth: '60px', textAlign: 'right' }}>฿{Math.round(vehicleProducts).toLocaleString('th-TH')}</span>
                                              </div>
                                              
                                              <div style={{ 
                                                fontSize: '12px', 
                                                marginLeft: '6px', 
                                                marginBottom: '4px',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                paddingRight: '4px'
                                              }}>
                                                <span style={{ flex: 1 }}>• ค่าใช้จ่ายอื่น ๆ</span>
                                                <span style={{ fontWeight: 600, minWidth: '60px', textAlign: 'right' }}>฿{Math.round(vehicleExpenses).toLocaleString('th-TH')}</span>
                                              </div>

                                              <div style={{ 
                                                fontSize: '14px', 
                                                fontWeight: 700, 
                                                marginLeft: '6px', 
                                                borderTop: '2px solid #333', 
                                                paddingTop: '4px', 
                                                marginTop: '6px',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                paddingRight: '4px',
                                                backgroundColor: '#eee',
                                                padding: '6px 4px',
                                                borderRadius: '4px',
                                                border: '2px solid #eee'
                                              }}>
                                                <span style={{ color: '#000' }}>ยอดรวมทั้งหมด:</span>
                                                <span style={{ color: '#000', minWidth: '80px', textAlign: 'right' }}>฿{Math.round(grandTotal).toLocaleString('th-TH')}</span>
                                              </div>
                                            </div>
                                          );
                                        })()}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                
                              </div>
                            );
                          })()}
                        </div>
                      </>
                    );
                  })()}
                </Box>
              );
            })
          ) : selectedVehicleId && tripRecords && tripRecords.length > 0 ? (
            <Box className="section">
              {/* Single vehicle display - New Layout Style */}
              {(() => {
                const selectedVehicle = uniqueVehicles.find(v => v.id === Number(selectedVehicleId));
                const dateGroups = groupCustomersByDateRange(tripRecords);
                const itemRows = aggregateItemsByCustomer(tripRecords);
                const vehicleGrandTotal = itemRows.reduce((s, r) => s + (r.totalPrice || 0), 0);
                
                return (
                  <>
                    {/* Vehicle Header - Compact */}
                    <div style={{ 
                      
                      padding: '4px',
                      marginBottom: '4px',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      fontWeight: 700,
                      fontSize: '12px'
                    }}>
                      <div>
                        {selectedVehicle ? `${selectedVehicle.licensePlate} - ${selectedVehicle.brand} ${selectedVehicle.model} (${getVehicleTypeLabel(selectedVehicle.vehicleType)})` : 'รถที่เลือก'}
                      </div>
                      <div style={{ fontSize: '12px', fontWeight: 'normal' }}>
                        {selectedVehicle && (() => {
                          const drivers = getVehicleDrivers(selectedVehicle.id, tripRecords);
                          if (drivers.length > 0) {
                            return `คนขับ: ${drivers.join(', ')}`;
                          }
                          return '';
                        })()}
                      </div>
                    </div>

                    {/* Main Data Table - Compact */}
                    <table style={{ 
                      width: '100%', 
                      borderCollapse: 'collapse',
                      fontSize: '12px',
                      marginBottom: '3px'
                    }}>
                      <thead>
                        <tr>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '12%'
                          }}>วันที่ไป-กลับ</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '12%'
                          }}>ลูกค้า</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '10%'
                          }}>คนขับ</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '8%'
                          }}>เลขที่เอกสาร</th>
                          
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '12%'
                          }}>ระยะทาง</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '7%'
                          }}>เบี้ยเลี้ยง</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '18%'
                          }}>พัสดุที่นำกลับ</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '10%'
                          }}>ค่าใช้จ่าย</th>
                          <th style={{ 
                            border: '1px solid #000',
                            padding: '2px',
                            textAlign: 'center',
                            fontWeight: 700,
                            width: '12%'
                          }}>หมายเหตุ</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.keys(dateGroups).sort().map((dateRangeKey) => {
                          const customerGroups = dateGroups[dateRangeKey];
                          
                          return Object.keys(customerGroups).map((customerKey, customerIndex) => {
                            const list = customerGroups[customerKey];
                            const customerName = customerKey.split('::')[1] || 'ไม่ระบุลูกค้า';
                            
                            // Get document numbers for this customer  
                            const documentNumbers = list.filter(t => t.documentNumber && t.documentNumber.trim()).map(t => t.documentNumber);
                            const uniqueDocNumbers = [...new Set(documentNumbers)];
                            const docNumberText = uniqueDocNumbers.length > 0 ? uniqueDocNumbers.join(', ') : '-';
                            
                            // Calculate customer totals
                            const totalActualDist = list.reduce((sum, trip) => {
                              const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                              return sum + actualDist;
                            }, 0);
                            const totalEstimatedDist = list.reduce((sum, trip) => {
                              const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                              return sum + estimatedDist;
                            }, 0);
                            const totalAllowance = list.reduce((sum, trip) => sum + (typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance), 0);
                            
                            // Get items and expenses for this customer
                            const cid = customerKey.split('::')[0];
                            const customerItems = itemRows.filter(r => r.customerId === parseInt(cid || '0'));
                            
                            // Calculate expenses
                            const totalDistanceCheckFee = list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0);
                            const totalFuelCost = list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0);
                            const totalTollFee = list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0);
                            const totalRepairCost = list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0);
                            const totalExpenses = totalDistanceCheckFee + totalFuelCost + totalTollFee + totalRepairCost;
                            
                            // Calculate total signed difference by summing individual trip differences with sign
                            const totalAbsoluteDifference = list.reduce((sum, trip) => {
                              const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                              const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                              return sum + (actualDist - estimatedDist);
                            }, 0);
                            
                            // Get remarks
                            const remarks = list.filter(t => t.remark && t.remark.trim()).map(t => t.remark).join('; ');
                            
                            return (
                              <React.Fragment key={`${dateRangeKey}-${customerKey}`}>
                                {/* Single row with all data */}
                                <tr>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center',
                                    fontWeight: 700,
                                    backgroundColor: customerIndex === 0 ? '#f5f5f5' : 'transparent'
                                  }}>
                                    {customerIndex === 0 ? (
                                      <div style={{ fontSize: '12px', fontWeight: 500 }}>{dateRangeKey}</div>
                                    ) : null}
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center',
                                    fontWeight: 600
                                  }}>
                                    <div style={{ fontSize: '12px', fontWeight: 700 }}>{customerName}</div>
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center',
                                    fontWeight: 600
                                  }}>
                                    <div style={{ fontSize: '12px', fontWeight: 700 }}>
                                      {(() => {
                                        const drivers = getCustomerDrivers(list);
                                        return drivers.length > 0 ? drivers.join(', ') : 'ไม่ระบุ';
                                      })()}
                                    </div>
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center'
                                  }}>
                                    <div style={{ fontSize: '12px', fontWeight: 700 }}>{docNumberText}</div>
                                  </td>
                                  
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center'
                                  }}>
                                    <div style={{ fontSize: '12px' }}>ประมาณ: {Math.round(totalEstimatedDist)}</div>
                                    <div style={{ fontSize: '12px' }}>จริง: {Math.round(totalActualDist)}</div>
                                    <div style={{ fontSize: '12px', fontWeight: 700 }}>
                                      ต่าง: {totalAbsoluteDifference >= 0 ? '+' : ''}{Math.round(totalAbsoluteDifference)} กม
                                    </div>
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center'
                                  }}>
                                    <div style={{ fontSize: '12px', fontWeight: 700 }}>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</div>
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '2px',
                                    textAlign: 'center',
                                    fontSize: '12px'
                                  }}>
                                    {customerItems.length > 0 ? (
                                      <div>
                                        {customerItems.map((item, idx) => (
                                          <div key={idx} style={{ marginBottom: '1px' }}>
                                            <strong>{item.name}</strong><br /> {Number(item.quantity).toLocaleString('th-TH')}{item.unit || ''} = ฿{Math.round(item.totalPrice).toLocaleString('th-TH')}
                                          </div>
                                        ))}
                                        <div style={{ fontWeight: 700, marginTop: '1px', borderTop: '1px solid #ddd', paddingTop: '1px' }}>
                                          รวม: ฿{customerItems.reduce((s, r) => s + (r.totalPrice || 0), 0).toLocaleString('th-TH')}
                                        </div>
                                      </div>
                                    ) : '-'}
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '5px',
                                    textAlign: 'left',
                                    fontSize: '12px'
                                  }}>
                                    {totalExpenses > 0 ? (
                                      <div>
                                        {totalDistanceCheckFee > 0 && <div>เช็คระยะ: ฿{Math.round(totalDistanceCheckFee).toLocaleString('th-TH')}</div>}
                                        {totalFuelCost > 0 && <div>น้ำมัน: ฿{Math.round(totalFuelCost).toLocaleString('th-TH')}</div>}
                                        {totalTollFee > 0 && <div>ทางด่วน: ฿{Math.round(totalTollFee).toLocaleString('th-TH')}</div>}
                                        {totalRepairCost > 0 && <div>ซ่อมแซม: ฿{Math.round(totalRepairCost).toLocaleString('th-TH')}</div>}
                                        <div style={{ fontWeight: 700, marginTop: '1px', borderTop: '1px solid #ddd', paddingTop: '1px' }}>
                                          รวม: ฿{Math.round(totalExpenses).toLocaleString('th-TH')}
                                        </div>
                                      </div>
                                    ) : '-'}
                                  </td>
                                  <td style={{ 
                                    border: '1px solid #000',
                                    padding: '5px',
                                    textAlign: 'left',
                                    fontSize: '12px'
                                  }}>
                                    {remarks.length > 25 ? remarks.substring(0, 25) + '...' : remarks || '-'}
                                  </td>
                                </tr>
                              </React.Fragment>
                            );
                          });
                        })}
                      </tbody>
                      <tfoot>
                        <tr>
                          <td colSpan={6} style={{ 
                            border: '1px solid #000',
                            padding: '4px',
                            textAlign: 'right',
                            fontWeight: 700,
                            fontSize: '12px',
                            backgroundColor: '#f0f0f0'
                          }}>รวมทั้งหมด:</td>
                          <td style={{ 
                            border: '1px solid #000',
                            padding: '4px',
                            textAlign: 'center',
                            fontWeight: 700,
                            fontSize: '12px',
                            backgroundColor: '#f0f0f0'
                          }}>
                            ฿{(() => {
                              const totalAllowance = tripRecords.reduce((sum, trip) => {
                                const allowance = typeof trip.totalAllowance === 'string' 
                                  ? parseFloat(trip.totalAllowance) || 0 
                                  : trip.totalAllowance || 0;
                                return sum + allowance;
                              }, 0);
                              return Math.round(totalAllowance).toLocaleString('th-TH');
                            })()}
                          </td>
                          <td style={{ 
                            border: '1px solid #000',
                            padding: '4px',
                            textAlign: 'center',
                            fontWeight: 700,
                            fontSize: '12px',
                            backgroundColor: '#f0f0f0'
                          }}>
                            ฿{(() => {
                              const totalItems = tripRecords.reduce((sum, trip) => {
                                const itemsTotal = trip.tripItems?.reduce((itemSum: number, item: any) => {
                                  const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice;
                                  return itemSum + price;
                                }, 0) || 0;
                                return sum + itemsTotal;
                              }, 0);
                              return Math.round(totalItems).toLocaleString('th-TH');
                            })()}
                          </td>
                          <td style={{ 
                            border: '1px solid #000',
                            padding: '4px',
                            textAlign: 'center',
                            fontWeight: 700,
                            fontSize: '12px',
                            backgroundColor: '#f0f0f0'
                          }}>
                            ฿{(() => {
                              const totalExpenses = tripRecords.reduce((sum, trip) => {
                                const distanceCheckFee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                                const fuelCost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                                const tollFee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                                const repairCost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                                return sum + distanceCheckFee + fuelCost + tollFee + repairCost;
                              }, 0);
                              return Math.round(totalExpenses).toLocaleString('th-TH');
                            })()}
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                    
                    {/* Vehicle Summary - Detailed */}
                    <div style={{ 
                       
                      padding: '4px', 
                      fontSize: '12px',
                      marginTop: '2px',
                      backgroundColor: '#f9f9f9'
                    }}>
                      {(() => {
                        // Calculate total products/services value
                        const vehicleProducts = tripRecords.reduce((sum, trip) => {
                          const itemsTotal = trip.tripItems?.reduce((itemSum: number, item: any) => {
                            const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice;
                            return itemSum + price;
                          }, 0) || 0;
                          return sum + itemsTotal;
                        }, 0);

                        // Calculate total other expenses for this vehicle
                        const vehicleExpenses = tripRecords.reduce((sum, trip) => {
                          const distanceCheckFee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                          const fuelCost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                          const tollFee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                          const repairCost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                          return sum + distanceCheckFee + fuelCost + tollFee + repairCost;
                        }, 0);

                        // Calculate item categories breakdown with quantities
                        const itemCategories = new Map();
                        tripRecords.forEach(trip => {
                          trip.tripItems?.forEach((item: any) => {
                            const name = item?.item?.ptDesc1 || item?.itemName || item?.item?.ptPart || 'พัสดุอื่นๆ';
                            const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice || 0;
                            const qty = typeof item.quantity === 'string' ? parseFloat(item.quantity) || 0 : item.quantity || 0;
                            const unit = item?.unit || item?.item?.ptUm || 'หน่วย';
                            
                            const existing = itemCategories.get(name) || { total: 0, qty: 0, unit: unit };
                            itemCategories.set(name, {
                              total: existing.total + price,
                              qty: existing.qty + qty,
                              unit: unit
                            });
                          });
                        });

                        // Calculate expense categories breakdown
                        const expenseCategories = new Map();
                        tripRecords.forEach(trip => {
                          const distanceCheckFee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                          const fuelCost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                          const tollFee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                          const repairCost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                          
                          if (distanceCheckFee > 0) expenseCategories.set('ค่าเช็คระยะ', (expenseCategories.get('ค่าเช็คระยะ') || 0) + distanceCheckFee);
                          if (fuelCost > 0) expenseCategories.set('ค่าน้ำมัน', (expenseCategories.get('ค่าน้ำมัน') || 0) + fuelCost);
                          if (tollFee > 0) expenseCategories.set('ค่าทางด่วน', (expenseCategories.get('ค่าทางด่วน') || 0) + tollFee);
                          if (repairCost > 0) expenseCategories.set('ค่าซ่อมแซม', (expenseCategories.get('ค่าซ่อมแซม') || 0) + repairCost);
                        });

                        return (
                          <div 
                            className="three-column-summary"
                            style={{ 
                              display: 'grid', 
                              gridTemplateColumns: '1fr 1fr 1fr',
                              gap: '12px', 
                              width: '100%',
                              alignItems: 'start',
                              minHeight: '200px'
                            }}>                        
                            
                            {/* Column 1 - Products/Services */}
                            <div className="column-cell" style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                              <div className="column-content" style={{ width: '100%' }}>
                                <div style={{ fontWeight: 700, marginBottom: '12px', textAlign: 'center' }}>พัสดุที่นำกลับ</div>
                              
                              {/* Products/Services Breakdown */}
                              <div style={{ marginBottom: '8px', flex: '1', border: '1px solid #e0e0e0', borderRadius: '4px', padding: '8px', backgroundColor: '#f8f9fa', minHeight: '150px' }}>
                                {Array.from(itemCategories.entries()).length > 0 ? (
                                  Array.from(itemCategories.entries()).map(([name, data]) => (
                                    <div key={name} style={{ 
                                      fontSize: '11px', 
                                      marginBottom: '4px',
                                      display: 'block',
                                      width: '100%'
                                    }}>
                                      <div style={{ 
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'flex-start',
                                        marginBottom: '2px'
                                      }}>
                                        <span style={{ 
                                          flex: 1, 
                                          paddingRight: '4px',
                                          lineHeight: '1.3',
                                          wordWrap: 'break-word',
                                          overflowWrap: 'break-word',
                                          hyphens: 'auto'
                                        }}>
                                          • {name}
                                        </span>
                                        <span style={{ 
                                          fontWeight: 600, 
                                          minWidth: '50px', 
                                          textAlign: 'right', 
                                          whiteSpace: 'nowrap',
                                          marginLeft: '4px'
                                        }}>
                                          ฿{Math.round(data.total).toLocaleString('th-TH')}
                                        </span>
                                      </div>
                                      <div style={{ 
                                        fontSize: '10px', 
                                        color: '#666',
                                        marginLeft: '8px',
                                        lineHeight: '1.2'
                                      }}>
                                        ({Math.round(data.qty).toLocaleString('th-TH')} {data.unit})
                                      </div>
                                    </div>
                                  ))
                                ) : (
                                  <div style={{ 
                                    fontSize: '11px', 
                                    color: '#666',
                                    fontStyle: 'italic',
                                    textAlign: 'center',
                                    padding: '20px'
                                  }}>
                                    ไม่มีพัสดุที่นำกลับ
                                  </div>
                                )}
                                <div style={{ 
                                  fontSize: '12px', 
                                  fontWeight: 700, 
                                  borderTop: '2px solid #007bff', 
                                  paddingTop: '6px', 
                                  marginTop: '8px',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  backgroundColor: '#e3f2fd',
                                  padding: '6px 8px',
                                  borderRadius: '4px'
                                }}>
                                  <span>รวมทั้งหมด:</span>
                                  <span style={{ minWidth: '55px', textAlign: 'right', color: '#1976d2', whiteSpace: 'nowrap' }}>฿{Math.round(vehicleProducts).toLocaleString('th-TH')}</span>
                                </div>
                              </div>
                            </div>
                            
                            {/* Column 2 - Expenses */}
                            <div className="column-cell" style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                              <div className="column-content" style={{ width: '100%' }}>
                                <div style={{ fontWeight: 700, marginBottom: '12px', textAlign: 'center' }}>ค่าใช้จ่ายอื่น ๆ</div>
                              
                              {/* Expenses Breakdown */}
                              <div style={{ marginBottom: '8px', flex: '1', border: '1px solid #e0e0e0', borderRadius: '4px', padding: '8px', backgroundColor: '#fff3e0', minHeight: '150px' }}>
                                {Array.from(expenseCategories.entries()).length > 0 ? (
                                  <div>
                                    {Array.from(expenseCategories.entries()).map(([name, total]) => (
                                      <div key={name} style={{ 
                                        fontSize: '11px', 
                                        marginBottom: '4px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'flex-start'
                                      }}>
                                        <span style={{ 
                                          flex: 1, 
                                          paddingRight: '4px',
                                          lineHeight: '1.3',
                                          wordWrap: 'break-word',
                                          overflowWrap: 'break-word'
                                        }}>• {name}</span>
                                        <span style={{ 
                                          fontWeight: 600, 
                                          minWidth: '50px', 
                                          textAlign: 'right', 
                                          whiteSpace: 'nowrap',
                                          marginLeft: '4px'
                                        }}>
                                          ฿{Math.round(total).toLocaleString('th-TH')}
                                        </span>
                                      </div>
                                    ))}
                                    <div style={{ 
                                      fontSize: '12px', 
                                      fontWeight: 700, 
                                      borderTop: '2px solid #ff9800', 
                                      paddingTop: '6px', 
                                      marginTop: '8px',
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      alignItems: 'center',
                                      backgroundColor: '#fff3e0',
                                      padding: '6px 8px',
                                      borderRadius: '4px'
                                    }}>
                                      <span>รวมทั้งหมด:</span>
                                      <span style={{ minWidth: '55px', textAlign: 'right', color: '#f57c00', whiteSpace: 'nowrap' }}>฿{Math.round(vehicleExpenses).toLocaleString('th-TH')}</span>
                                    </div>
                                  </div>
                                ) : (
                                  <div style={{ 
                                    fontSize: '11px', 
                                    color: '#666',
                                    fontStyle: 'italic',
                                    textAlign: 'center',
                                    padding: '20px'
                                  }}>
                                    ไม่มีค่าใช้จ่ายอื่น ๆ
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Column 3 - Grand Total Summary */}
                            <div className="column-cell" style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                              <div className="column-content" style={{ width: '100%' }}>
                                <div style={{ fontWeight: 700, marginBottom: '12px', textAlign: 'center' }}>สรุปยอดรวม</div>
                              
                              {/* Grand Total Section */}
                              <div style={{ marginBottom: '8px', flex: '1', border: '1px solid #e0e0e0', borderRadius: '4px', padding: '8px', backgroundColor: '#f1f8e9', minHeight: '150px' }}>
                                {(() => {
                                  // Calculate total allowance for this vehicle
                                  const totalAllowance = tripRecords.reduce((sum, trip) => {
                                    const allowance = typeof trip.totalAllowance === 'string' 
                                      ? parseFloat(trip.totalAllowance) || 0 
                                      : trip.totalAllowance || 0;
                                    return sum + allowance;
                                  }, 0);

                                  const grandTotal = vehicleProducts + vehicleExpenses + totalAllowance;

                                  return (
                                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                                      <div style={{ flex: '1' }}>
                                        <div style={{ 
                                          fontSize: '11px', 
                                          marginBottom: '4px',
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center'
                                        }}>
                                          <span style={{ flex: 1, paddingRight: '4px' }}>• เบี้ยเลี้ยง</span>
                                          <span style={{ fontWeight: 600, minWidth: '50px', textAlign: 'right', whiteSpace: 'nowrap' }}>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</span>
                                        </div>
                                        
                                        <div style={{ 
                                          fontSize: '11px', 
                                          marginBottom: '4px',
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center'
                                        }}>
                                          <span style={{ flex: 1, paddingRight: '4px' }}>• พัสดุ</span>
                                          <span style={{ fontWeight: 600, minWidth: '50px', textAlign: 'right', whiteSpace: 'nowrap' }}>฿{Math.round(vehicleProducts).toLocaleString('th-TH')}</span>
                                        </div>
                                        
                                        <div style={{ 
                                          fontSize: '11px', 
                                          marginBottom: '8px',
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center'
                                        }}>
                                          <span style={{ flex: 1, paddingRight: '4px' }}>• ค่าใช้จ่าย</span>
                                          <span style={{ fontWeight: 600, minWidth: '50px', textAlign: 'right', whiteSpace: 'nowrap' }}>฿{Math.round(vehicleExpenses).toLocaleString('th-TH')}</span>
                                        </div>
                                      </div>

                                      <div style={{ 
                                        fontSize: '14px', 
                                        fontWeight: 700, 
                                        borderTop: '2px solid #4caf50', 
                                        paddingTop: '6px', 
                                        marginTop: 'auto',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        backgroundColor: '#e8f5e8',
                                        padding: '8px',
                                        borderRadius: '4px',
                                        border: '2px solid #4caf50'
                                      }}>
                                        <span style={{ color: '#2e7d32', flex: 1, paddingRight: '4px' }}>ยอดรวมทั้งหมด:</span>
                                        <span style={{ minWidth: '75px', textAlign: 'right', color: '#2e7d32', fontSize: '16px', whiteSpace: 'nowrap' }}>฿{Math.round(grandTotal).toLocaleString('th-TH')}</span>
                                      </div>
                                    </div>
                                  );
                                })()}
                              </div>
                              </div>
                            </div>
                            
                          </div>
                        );
                      })()}
                    </div>
              );
            })()}
          </Box>
        ) : null}
        
        {/* Header */}
        <Box sx={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: { xs: 'flex-start', sm: 'center' }, 
          mb: { xs: 3, print: 1 },
          flexDirection: { xs: 'column', sm: 'row' },
          gap: { xs: 2, sm: 1, print: 0.5 }
        }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: { xs: 1, print: 0.5 } }}>

            <Typography 
              variant={isMobile ? "h5" : "h6"} 
              component="h1" 
              fontWeight="bold"
              sx={{
                '@media print': {
                  fontSize: '14px !important',
                  margin: '0 !important',
                  fontWeight: 'bold',
                }
              }}
            >
              รายงานการเดินทาง
            </Typography>
          </Box>
          
          {/* Action Buttons - Compact */}
          <Box data-print-hide sx={{ 
            display: 'flex', 
            gap: 1, 
            flexDirection: { xs: 'column', sm: 'row' },
            width: { xs: '100%', sm: 'auto' }
          }}>
            <Button
              variant="outlined"
              startIcon={<BackIcon />}
              onClick={() => router.back()}
              size="small"
              sx={{ 
                borderColor: 'grey.300',
                color: 'grey.700',
                '&:hover': { borderColor: 'grey.400' },
                minWidth: { xs: '100%', sm: 'auto' }
              }}
            >
              กลับ
            </Button>

          </Box>
        </Box>

{/* Filters - Compact (Adjusted) */}
<Paper sx={{ p: 2, mb: 2, borderRadius: 3 }}>
  <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1.5 }}>
    <Typography variant="h6" fontWeight="bold" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
      <CalendarIcon color="primary" />
      เลือกข้อมูล
    </Typography>
    
  </Box>

  <Box sx={{ 
    display: 'grid', 
    // ปรับ grid layout ให้เลือกทะเบียนกว้างกว่า และปุ่มล้างอยู่ท้าย
    gridTemplateColumns: { 
      xs: '1fr', 
      sm: '2fr 1fr auto', 
      lg: '3fr 1fr 1fr auto' 
    }, 
    gap: 1.5,
    alignItems: 'center'
  }}>

    {/* Filter 1: เลือกรถ - กว้างกว่าอันอื่น */}
    <FormControl fullWidth size="small">
      <InputLabel>เลือกทะเบียน</InputLabel>
      <Select
        value={selectedVehicleId}
        label="เลือกทะเบียน"
        onChange={(e) => {
          setSelectedVehicleId(e.target.value);
        }}
      >
        <MenuItem value="">-- เลือกทะเบียน --</MenuItem>
        {(Array.isArray(vehicles) ? vehicles : [])
          .filter((vehicle) => vehicle.vehicleType?.toLowerCase() === 'truck')
          .map((vehicle) => (
          <MenuItem key={vehicle.id} value={vehicle.id.toString()}>
            {vehicle.licensePlate} - {vehicle.brand} {vehicle.model} ({getVehicleTypeLabel(vehicle.vehicleType)})
          </MenuItem>
        ))}
      </Select>
    </FormControl>

    {/* Filter 2: เดือน */}
    <FormControl fullWidth size="small">
      <InputLabel>เดือน</InputLabel>
      <Select
        value={selectedMonth}
        label="เดือน"
        onChange={(e) => setSelectedMonth(e.target.value)}
      >
        {months.map((month) => (
          <MenuItem key={month.value} value={month.value}>
            {month.label}
          </MenuItem>
        ))}
      </Select>
    </FormControl>

    {/* Filter 3: ปี */}
    <FormControl fullWidth size="small">
      <InputLabel>ปี</InputLabel>
      <Select
        value={selectedYear}
        label="ปี"
        onChange={(e) => setSelectedYear(e.target.value)}
      >
        {getAvailableYears().map((year) => (
          <MenuItem key={year} value={year.toString()}>
            {year + 543}
          </MenuItem>
        ))}
      </Select>
    </FormControl>

    {/* Button: ล้างทั้งหมด - อยู่ท้ายสุด */}
    <Button
      variant="outlined"
      onClick={handleClearFilters}
      size="small"
      sx={{ whiteSpace: 'nowrap', minWidth: 'auto' }}
    >
      ล้างทั้งหมด
    </Button>
  </Box>
</Paper>

        {/* Loading */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
            <CircularProgress />
          </Box>
        )}

        {/* No Data */}
        {!loading && (!tripRecords || tripRecords.length === 0) && selectedVehicleId && selectedMonth && selectedYear && (
          <Paper sx={{ p: 4, textAlign: 'center', bgcolor: 'grey.50' }}>
            <Typography variant="h6" color="text.secondary" gutterBottom>
              ไม่พบข้อมูลการเดินทาง
            </Typography>
            <Typography variant="body2" color="text.secondary">
              สำหรับรถที่เลือกในเดือน {months.find(m => m.value === selectedMonth)?.label} ปี {parseInt(selectedYear) + 543}
            </Typography>
          </Paper>
        )}

        {/* Data Display */}
        {!loading && tripRecords && tripRecords.length > 0 && selectedVehicleId && (
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
            {/* Summary Section */}
            {selectedVehicleId && (
              <Paper sx={{ 
                p: { xs: 3, print: 1 }, 
                borderRadius: { xs: 3, print: 0 }, 
                bgcolor: { xs: 'grey.50', print: 'transparent' }, 
                border: { xs: '1px solid rgba(0,0,0,0.05)', print: '1px solid #000' },
                '@media print': {
                  boxShadow: 'none',
                  margin: '4px 0'
                }
              }}>
                {/* Vehicle Info for Selected Vehicle */}
                {selectedVehicleId && (
                  <Box sx={{ mb: { xs: 3, print: 1 } }}>
                    <Box sx={{ 
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      alignItems: 'flex-start',
                      mb: { xs: 2, print: 0.5 }
                    }}>
                      <Typography variant="h6" fontWeight="bold" sx={{ 
                        '@media print': {
                          fontSize: '12px !important',
                          margin: '0 0 4px 0 !important'
                        }
                      }}>
                        ข้อมูลรถที่เลือก
                      </Typography>
                      
                      {/* PDF Download Button */}
                      <Box data-print-hide sx={{ ml: 2 }}>
                        {(() => {
                          // เงื่อนไขการอนุญาตกด Export PDF รายละเอียด
                          // ต้องเลือก vehicle, month, year และมี tripRecords > 0
                          const hasData = Array.isArray(tripRecords) && tripRecords.length > 0;
                          const canExportDetailed = !!selectedVehicleId && !!selectedMonth && !!selectedYear && hasData;
                          const reason = !hasData
                            ? 'ยังไม่มีข้อมูล' 
                            : !selectedVehicleId
                              ? 'เลือกรถก่อน'
                              : !selectedMonth || !selectedYear
                                ? 'เลือกเดือนและปีก่อน'
                                : '';
                          return (
                            <Button
                              variant="contained"
                              startIcon={<DownloadIcon />}
                              onClick={canExportDetailed ? exportToPDF : undefined}
                              disabled={isExporting || !canExportDetailed}
                              title={canExportDetailed ? 'ส่งออก PDF' : `ไม่สามารถส่งออก: ${reason}`}
                              sx={{ 
                                minWidth: 'auto',
                                whiteSpace: 'nowrap',
                                borderRadius: 1,
                              }}
                            >
                              {isExporting ? 'กำลังสร้าง...' : 'ดาวน์โหลด PDF'}
                            </Button>
                          );
                        })()}
                      </Box>
                    </Box>
                    <Typography variant="body2" color="text.secondary" sx={{
                      lineHeight: 1.6,
                      '@media print': {
                        fontSize: '10px !important',
                        margin: '0 0 4px 0 !important',
                        color: '#000 !important'
                      }
                    }}>
                      {(() => {
                        const vehicle = vehicles.find(v => v.id.toString() === selectedVehicleId);
                        const monthName = months.find(m => m.value === selectedMonth)?.label || selectedMonth;
                        const yearDisplay = parseInt(selectedYear) + 543;
                        
                        return vehicle 
                          ? `${monthName} ${yearDisplay} | รถ: ${vehicle.licensePlate} - ${vehicle.brand} ${vehicle.model} (${getVehicleTypeLabel(vehicle.vehicleType)}) | คนขับ: ${getVehicleDrivers(vehicle.id, tripRecords).join(', ')} | จำนวนรอบ: ${tripRecords.length} เที่ยว`
                          : '';
                      })()
                      }
                    </Typography>
                  </Box>
                )}

                {/* Vehicle Info for Single Vehicle */}
                {selectedVehicleId && (
                  <Box sx={{ mb: { xs: 3, print: 1 } }}>
                    <Typography variant="h6" fontWeight="bold" sx={{ 
                      mb: { xs: 2, print: 0.5 },
                      '@media print': {
                        fontSize: '12px !important',
                        margin: '0 0 4px 0 !important'
                      }
                    }}>
                      ข้อมูลรถ
                    </Typography>
                    {(() => {
                      const selectedVehicle = (Array.isArray(vehicles) ? vehicles : []).find(v => v.id.toString() === selectedVehicleId);
                      return selectedVehicle ? (
                        <Box>
                          <Typography variant="body2" color="text.secondary" sx={{ 
                            mb: { xs: 1, print: 0.2 },
                            '@media print': {
                              fontSize: '10px !important',
                              color: '#000 !important',
                              margin: '0 !important'
                            }
                          }}>
                            รถ: {selectedVehicle.licensePlate} - {selectedVehicle.brand} {selectedVehicle.model} ({getVehicleTypeLabel(selectedVehicle.vehicleType)}) | คนขับ: {getVehicleDrivers(selectedVehicle.id, tripRecords).join(', ')} | จำนวนเที่ยว: {tripRecords.length} เที่ยว 
                            <br />
                            {(() => {
                              const monthName = months.find(m => m.value === selectedMonth)?.label || selectedMonth;
                              const yearDisplay = parseInt(selectedYear) + 543;
                              return `${monthName} ${yearDisplay}`;
                            })()}
                          </Typography>
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mt: 1 }}>
                            <VehicleImage vehicle={selectedVehicle} size={40} />
                            <Chip 
                              label={selectedVehicle.licensePlate}
                              variant="outlined"
                              size="small"
                              color="primary"
                            />
                            <Chip 
                              label={getVehicleDrivers(selectedVehicle.id, tripRecords).join(', ') || 'ไม่มีข้อมูลคนขับ'}
                              variant="outlined"
                              size="small"
                              color="primary"
                            />
                          </Box>
                        </Box>
                      ) : null;
                    })()}
                  </Box>
                )}

                {/* Summary Cards - Compact */}
                <Box sx={{ 
                  display: 'flex', 
                  flexWrap: 'wrap',
                  gap: { xs: 1, print: 0.5 },
                  '@media print': {
                    margin: '2px 0'
                  }
                }}>
                  {/* Summary cards for selected vehicle */}

                  
                  <Box sx={{ 
                    textAlign: 'center', 
                    p: { xs: 1, print: 0.3 }, 
                    bgcolor: { xs: 'white', print: 'transparent' }, 
                    borderRadius: { xs: 2, print: 0 }, 
                    border: { xs: '1px solid rgba(0,0,0,0.1)', print: '1px solid #000' },
                    minWidth: 'fit-content',
                    flex: '1 1 auto'
                  }}>
                    <Typography variant="caption" color="text.secondary" sx={{
                      '@media print': { fontSize: '6px !important', color: '#000 !important' },
                      display: 'block',
                      mb: 0.5
                    }}>
                      จำนวนเที่ยว
                    </Typography>
                    <Typography variant="body2" sx={{
                      '@media print': { fontSize: '7px !important', color: '#000 !important' }
                    }}>
                      <strong>{tripRecords?.length || 0}</strong> เที่ยว
                    </Typography>
                  </Box>
                  
                  <Box sx={{ 
                    textAlign: 'center', 
                    p: { xs: 1, print: 0.3 }, 
                    bgcolor: { xs: 'white', print: 'transparent' }, 
                    borderRadius: { xs: 2, print: 0 }, 
                    border: { xs: '1px solid rgba(0,0,0,0.1)', print: '1px solid #000' },
                    minWidth: 'fit-content',
                    flex: '1 1 auto'
                  }}>
                    <Typography variant="caption" color="text.secondary" sx={{
                      '@media print': { fontSize: '6px !important', color: '#000 !important' },
                      display: 'block',
                      mb: 0.5
                    }}>
                      ระยะทาง (จริง/ประมาณ)
                    </Typography>
                    <Typography variant="body2" sx={{
                      '@media print': { fontSize: '7px !important', color: '#000 !important' }
                    }}>
                      จริง <strong>{Math.round(totalDistance)}</strong> กม. / 
                      ประมาณ <strong>{Math.round(totalEstimatedDistance)}</strong> กม.<br/>
                      ส่วนต่าง <Typography component="span" sx={{ color: 'text.primary' }}>
                        <strong>{totalDistanceDifference >= 0 ? '+' : ''}{Math.round(totalDistanceDifference)} กม.</strong>
                      </Typography>
                    </Typography>
                  </Box>
    
                  <Box sx={{ 
                    textAlign: 'center', 
                    p: { xs: 1, print: 0.3 }, 
                    bgcolor: { xs: 'white', print: 'transparent' }, 
                    borderRadius: { xs: 2, print: 0 }, 
                    border: { xs: '1px solid rgba(0,0,0,0.1)', print: '1px solid #000' },
                    minWidth: 'fit-content',
                    flex: '1 1 auto'
                  }}>
                    <Typography variant="caption" color="text.secondary" sx={{
                      '@media print': { fontSize: '6px !important', color: '#000 !important' },
                      display: 'block',
                      mb: 0.5
                    }}>
                      มูลค่ารวม
                    </Typography>
                    <Typography variant="body2" sx={{
                      '@media print': { fontSize: '7px !important', color: '#000 !important' }
                    }}>
                      เบี้ยเลี้ยง <strong>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</strong> | 
                      พัสดุ <strong>฿{Math.round(totalItemsValue).toLocaleString('th-TH')}</strong> | <br/>
                      ค่าใช้จ่ายอื่นๆ <strong>฿{Math.round(totalOtherCosts).toLocaleString('th-TH')}</strong> |
                      รวม <strong>฿{Math.round(totalCosts).toLocaleString('th-TH')}</strong><br/>
                    </Typography>
                  </Box>
                </Box>
              </Paper>
            )}

            {/* Vehicle Trip Records */}
            {selectedVehicleId ? (
              // แสดงแยกตามรถ
              uniqueVehicles.map((vehicle) => {
                const vehicleTrips = tripRecords.filter(trip => trip.vehicle?.id === vehicle.id);
                const vehicleTotalDistance = vehicleTrips.reduce((sum, trip) => {
                  const distance = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                  return sum + distance;
                }, 0);
                const vehicleTotalEstimatedDistance = vehicleTrips.reduce((sum, trip) => {
                  const distance = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                  return sum + distance;
                }, 0);
                const vehicleTotalAllowance = vehicleTrips.reduce((sum, trip) => {
                  const allowance = typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance;
                  return sum + allowance;
                }, 0);
                const vehicleTotalDistanceCheckFee = vehicleTrips.reduce((sum, trip) => {
                  const fee = typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0;
                  return sum + fee;
                }, 0);
                const vehicleTotalFuelCost = vehicleTrips.reduce((sum, trip) => {
                  const cost = typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0;
                  return sum + cost;
                }, 0);
                const vehicleTotalTollFee = vehicleTrips.reduce((sum, trip) => {
                  const fee = typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0;
                  return sum + fee;
                }, 0);
                const vehicleTotalRepairCost = vehicleTrips.reduce((sum, trip) => {
                  const cost = typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0;
                  return sum + cost;
                }, 0);
                const vehicleTotalItemsValue = vehicleTrips.reduce((sum, trip) => {
                  const itemsTotal = trip.tripItems?.reduce((itemSum, item) => {
                    const price = typeof item.totalPrice === 'string' ? parseFloat(item.totalPrice) || 0 : item.totalPrice;
                    return itemSum + price;
                  }, 0) || 0;
                  return sum + itemsTotal;
                }, 0);
                const vehicleDistanceDifference = vehicleTrips.reduce((sum, trip) => {
                  const a = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                  const e = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                  return sum + (a - e);
                }, 0);

                return (
                  <Paper key={vehicle.id} sx={{ 
                      borderRadius: { xs: 2, print: 0 },
                      border: '1px solid #e5e5e5',
                      boxShadow: 'none',
                      overflow: 'hidden',
                      backgroundColor: '#fff',
                      '@media print': {
                        pageBreakInside: 'avoid',
                        margin: '4px 0'
                      }
                  }}>
                    {/* Vehicle Header - Compact */}
                    <Box sx={{ 
                        p: { xs: 1.5, print: 1 }, 
                        bgcolor: '#fafafa',
                        borderBottom: '1px solid #eee'
                      }}>
                          <Box sx={{ 
                            display: 'flex', 
                          justifyContent: 'space-between', 
                            alignItems: 'center', 
                          gap: { xs: 1.5, print: 1 }
                        }}>
                          <Box sx={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: { xs: 1.5, print: 1 } 
                          }}>
                            <Box sx={{ 
                              display: { xs: 'flex', print: 'none' }
                            }}>
                              <VehicleImage vehicle={vehicle} size={48} />
                          </Box>
                          <Box>
                            <Typography variant="h6" fontWeight="bold" sx={{
                              '@media print': {
                                fontSize: '10px !important',
                                margin: '0 !important',
                                fontWeight: 'bold'
                              }
                            }}>
                              {vehicle.licensePlate} - {vehicle.brand} {vehicle.model} ({getVehicleTypeLabel(vehicle.vehicleType)})
                            </Typography>
                            <Typography variant="body2" color="text.secondary" sx={{
                              '@media print': {
                                fontSize: '8px !important',
                                color: '#000 !important',
                                margin: '0 !important'
                              }
                            }}>
                                คนขับ: {getVehicleDrivers(vehicle.id, tripRecords).join(', ') || 'ไม่มีข้อมูลคนขับ'}
                              </Typography>
                        </Box>
                      </Box>

                      <Box sx={{ 
                          display: 'flex', 
                          gap: { xs: 1.5, print: 1 }, 
                          textAlign: 'right',
                          flexWrap: 'wrap',
                          flexDirection: 'column'
                        }}>

                          
                          {/* Trip & Distance Metrics */}
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, minWidth: 'fit-content', justifyContent: 'center' }}>
                            <Typography variant="body2" sx={{
                              '@media print': { fontSize: '7px !important', color: '#000 !important' }
                            }}>
                              <strong>{vehicleTrips.length}</strong> เที่ยว | 
                              ระยะทางจริง <strong>{Math.round(vehicleTotalDistance)}</strong> กม. / 
                              ระยะทางประมาณ <strong>{Math.round(vehicleTotalEstimatedDistance)}</strong> กม. | 
                              ส่วนต่าง <Typography component="span" sx={{ color: 'text.primary' }}>
                                <strong>{vehicleDistanceDifference >= 0 ? '+' : ''}{Math.round(vehicleDistanceDifference)}</strong>
                              </Typography> กม.
                            </Typography>
                          </Box>
                          
                          {/* Financial Metrics */}
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, minWidth: 'fit-content', justifyContent: 'center' }}>
                            <Typography variant="body2" sx={{
                              '@media print': { fontSize: '7px !important', color: '#000 !important' }
                            }}>
                              เบี้ยเลี้ยง <strong>฿{Math.round(vehicleTotalAllowance).toLocaleString('th-TH')}</strong> | 
                              พัสดุ <strong>฿{Math.round(vehicleTotalItemsValue).toLocaleString('th-TH')}</strong> |
                              ค่าอื่นๆ <strong>฿{Math.round(vehicleTotalDistanceCheckFee + vehicleTotalFuelCost + vehicleTotalTollFee + vehicleTotalRepairCost).toLocaleString('th-TH')}</strong> | 
                              รวม <strong style={{ color: "green" }}>฿{Math.round(vehicleTotalAllowance + vehicleTotalItemsValue + vehicleTotalDistanceCheckFee + vehicleTotalFuelCost + vehicleTotalTollFee + vehicleTotalRepairCost).toLocaleString('th-TH')}</strong>
                            </Typography>
                          </Box>
                          
                        </Box>
                      </Box>
                    </Box>

                    {/* Vehicle Trip Records - Desktop Table or Mobile Cards */}
                    {!isMobile ? (
                      <Box>
                        {(() => {
                          const dateGroups = groupCustomersByDateRange(vehicleTrips);
                          const itemsAll = aggregateItemsByCustomer(vehicleTrips);
                          const grand = itemsAll.reduce((s, r) => s + (r.totalPrice || 0), 0);
                          return (
                            <>
                              {Object.keys(dateGroups).sort().map((dateRangeKey) => {
                                const customerGroups = dateGroups[dateRangeKey];
                                
                                return Object.keys(customerGroups).map((customerKey) => {
                                  const customerName = customerKey.split('::')[1] || 'ไม่ระบุลูกค้า';
                                  const list = customerGroups[customerKey];
                                  const rowsForCustomer = itemsAll.filter(r => r.customerId === parseInt(customerKey.split('::')[0] || '0'));
                                  const sub = rowsForCustomer.reduce((s, r) => s + (r.totalPrice || 0), 0);
                                
                                // Calculate customer totals
                                const totalActualDist = list.reduce((sum, trip) => {
                                  const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                                  return sum + actualDist;
                                }, 0);
                                const totalEstimatedDist = list.reduce((sum, trip) => {
                                  const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                  return sum + estimatedDist;
                                }, 0);
                                const totalAllowance = list.reduce((sum, trip) => sum + (typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance), 0);
                                const totalDistanceCheckFee = list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0);
                                const totalFuelCost = list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0);
                                const totalTollFee = list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0);
                                const totalRepairCost = list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0);
                                const totalOtherCosts = totalDistanceCheckFee + totalFuelCost + totalTollFee + totalRepairCost;
                                // Calculate total signed difference by summing individual trip differences with sign
                                const totalAbsoluteDifference = list.reduce((sum, trip) => {
                                  const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                                  const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                  const diff = actualDist - estimatedDist;
                                  return sum + diff;
                                }, 0);
                                
                                // Debug: Log actual calculation for this customer group  
                                console.log('Desktop UI Debug:', {
                                  customerName: customerKey.split('::')[1],
                                  totalActual: totalActualDist,
                                  totalEstimated: totalEstimatedDist,
                                  directDiff: Math.abs(totalActualDist - totalEstimatedDist),
                                  summedAbsDiff: totalAbsoluteDifference,
                                  roundedSummedDiff: Math.round(totalAbsoluteDifference),
                                  individualDiffs: list.map(trip => {
                                    const actual = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                                    const estimated = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                    return Math.abs(actual - estimated);
                                  })
                                });
                                
                                return (
                                  <Paper key={`${dateRangeKey}-${customerKey}`} sx={{ p: 1, mb: 1, borderRadius: 0, border: '1px solid', borderColor: 'grey.200' }}>
                                    {/* Date Range Header */}
                                    <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 0.5, p: 0.5, backgroundColor: 'grey.100', borderRadius: 1}}>
                                      <Typography variant="caption" sx={{ fontWeight: 500, color: 'text.primary', fontSize: '0.85rem' }}>
                                        {dateRangeKey}
                                      </Typography>
                                      <Typography variant="caption" sx={{ fontWeight: 500, color: 'text.primary', fontSize: '0.85rem' }}>
                                        เลขที่: {list[0]?.documentNumber || 'ไม่ระบุ'}
                                      </Typography>
                                    </Box>
                                    
                                    
                                    {/* Customer Header - Compact */}
                                    <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 0.5, p: 0.5, backgroundColor: 'primary.50', borderRadius: 1 }}>
                                      <Typography variant="subtitle1" sx={{ fontWeight: 700, color: 'primary.main' }}>
                                        {customerName}
                                      </Typography>
                                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                        <Typography variant="caption" color="text.secondary" sx={{ fontSize: '0.85rem' }}>
                                          
                                           {list.length} เที่ยวรถ | คนขับ {list[0]?.driverName || 'ไม่ระบุ'} | ระยะทางจริง {Math.round(totalActualDist)} กม. | ระยะทางประมาณ {Math.round(totalEstimatedDist)} กม. | ส่วนต่าง {totalAbsoluteDifference >= 0 ? '+' : ''}{Math.round(totalAbsoluteDifference)} กม.
                                        </Typography>
                                        
                                      </Box>
                                    </Box>

                                    {/* Items Summary - Inline */}
                                    {rowsForCustomer.length > 0 && (
                                      <Box sx={{ mb: 0.5 }}>
                                        <Box sx={{ display: 'flex', alignItems: 'center', flexWrap: 'wrap', gap: 0.5 }}>
                                          <Typography variant="body2" sx={{ fontWeight: 600, color: 'text.secondary', minWidth: 'fit-content' }}>
                                            พัสดุ:
                                          </Typography>
                                          {rowsForCustomer.map((r, idx) => (
                                            <Chip
                                              key={idx}
                                              label={`${r.name} ${Number(r.quantity).toLocaleString('th-TH')}${r.unit || ''} (฿${Math.round(r.totalPrice).toLocaleString('th-TH')})`}
                                              size="small"
                                              variant="outlined"
                                              sx={{ fontSize: '0.8rem' }}
                                            />
                                          ))}
                                          <Typography variant="body2" sx={{ fontWeight: 700, color: 'success.main', ml: 'auto' }}>
                                            = ฿{Math.round(sub).toLocaleString('th-TH')}
                                          </Typography>
                                        </Box>

                                        {/* Allowance and Other Costs Summary */}
                                        <Box sx={{ mt: 1, display: 'flex', flexWrap: 'wrap', gap: 2, alignItems: 'center' }}>
                                          <Typography variant="body2" sx={{ fontWeight: 500,color: 'success.main' }}>
                                            เบี้ยเลี้ยง: <strong>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</strong>
                                          </Typography>
                                          {(() => {
                                            const otherCosts = [
                                              { label: 'เช็คระยะ', total: list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0) },
                                              { label: 'น้ำมัน', total: list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0) },
                                              { label: 'ทางด่วน', total: list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0) },
                                              { label: 'ซ่อมแซม', total: list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0) }
                                            ].filter(cost => cost.total > 0);
                                            
                                            const totalOtherCosts = otherCosts.reduce((sum, cost) => sum + cost.total, 0);
                                            
                                            return totalOtherCosts > 0 ? (
                                              <Typography variant="body2" sx={{ fontWeight: 500, color: 'warning.main' }}>
                                                ค่าใช้จ่ายอื่นๆ: <strong>฿{Math.round(totalOtherCosts).toLocaleString('th-TH')}</strong>
                                                <Typography component="span" sx={{ color: 'text.secondary', fontSize: '0.85rem', ml: 0.5 }}>
                                                  ({otherCosts.map(cost => `${cost.label} ฿${Math.round(cost.total).toLocaleString('th-TH')}`).join(', ')})
                                                </Typography>
                                              </Typography>
                                            ) : (
                                              <Typography variant="body2" sx={{ fontWeight: 500, color: 'text.secondary' }}>
                                                ค่าใช้จ่ายอื่นๆ: <strong>฿0</strong>
                                              </Typography>
                                            );
                                          })()}
                                        </Box>


                                      </Box>
                                    )}

                                    {/* Trip Details - Remarks Only (if any) */}
                                    {(() => {
                                      const tripsWithRemarks = list.filter(trip => trip.remark && trip.remark.trim());
                                      return tripsWithRemarks.length > 0 ? (
                                        <Accordion sx={{ boxShadow: 'none', '&:before': { display: 'none' }, mt: 0.5 }}>
                                          <AccordionSummary expandIcon={<ExpandMoreIcon />} sx={{ minHeight: '32px', py: 0.5, '& .MuiAccordionSummary-content': { margin: '4px 0' } }}>
                                            <Typography variant="body2" sx={{ color: 'text.secondary' }}>
                                              หมายเหตุเพิ่มเติม ({tripsWithRemarks.length} รายการ)
                                            </Typography>
                                          </AccordionSummary>
                                          <AccordionDetails sx={{ pt: 0, pb: 0.5 }}>
                                            {tripsWithRemarks.map((trip) => (
                                              <Box key={trip.id} sx={{ py: 0.5, mb: 0.5, backgroundColor: 'grey.25', borderRadius: 1, px: 0.75 }}>
                                                
                                                <Typography variant="body2" sx={{ fontStyle: 'italic', color: 'text.secondary', mt: 0.5 }}>
                                                  หมายเหตุ: {trip.remark}
                                                </Typography>
                                              </Box>
                                            ))}
                                          </AccordionDetails>
                                        </Accordion>
                                      ) : null;
                                    })()}
                                  </Paper>
                                );
                              });
                            })}
                              
                            </>
                          );
                        })()}
                      </Box>
                    ) : (
                      /* Mobile Cards for Vehicle Trips - Customer Grouped */
                      <Box sx={{ p: { xs: 2, sm: 1 } }}>
                        {(() => {
                          const dateGroups = groupCustomersByDateRange(vehicleTrips);
                          const itemsAll = aggregateItemsByCustomer(vehicleTrips);
                          
                          return (
                            <>
                              {Object.keys(dateGroups).sort().map((dateRangeKey) => {
                                const customerGroups = dateGroups[dateRangeKey];
                                
                                return Object.keys(customerGroups).map((customerKey) => {
                                  const customerName = customerKey.split('::')[1] || 'ไม่ระบุลูกค้า';
                                  const list = customerGroups[customerKey];
                                  const rowsForCustomer = itemsAll.filter(r => r.customerId === parseInt(customerKey.split('::')[0] || '0'));
                                  const sub = rowsForCustomer.reduce((s, r) => s + (r.totalPrice || 0), 0);
                                  
                                  // Calculate customer totals
                                  const totalActualDist = list.reduce((sum, trip) => {
                                    const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                                    return sum + actualDist;
                                  }, 0);
                                  const totalEstimatedDist = list.reduce((sum, trip) => {
                                    const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                  return sum + estimatedDist;
                                }, 0);
                                const totalAllowance = list.reduce((sum, trip) => sum + (typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance), 0);
                                const totalDistanceCheckFee = list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0);
                                const totalFuelCost = list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0);
                                const totalTollFee = list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0);
                                const totalRepairCost = list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0);
                                const totalOtherCosts = totalDistanceCheckFee + totalFuelCost + totalTollFee + totalRepairCost;
                                // Calculate total signed difference by summing individual trip differences with sign
                                const totalAbsoluteDifference = list.reduce((sum, trip) => {
                                  const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                                  const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                  const diff = actualDist - estimatedDist;
                                  return sum + diff;
                                }, 0);
                                
                                return (
                                  <Paper key={`${dateRangeKey}-${customerKey}`} sx={{ 
                                    p: { xs: 2, sm: 1 }, 
                                    mb: { xs: 2, sm: 1 }, 
                                    borderRadius: { xs: 3, sm: 0 }, 
                                    border: '1px solid', 
                                    borderColor: 'grey.200',
                                    boxShadow: { xs: '0 4px 12px rgba(0,0,0,0.08)', sm: 'none' }
                                  }}>
                                    {/* Date Range Header */}
                                    <Box sx={{ 
                                      display: 'flex', 
                                      justifyContent: 'center', 
                                      mb: { xs: 1, sm: 0.5 }, 
                                      p: { xs: 1, sm: 0.5 }, 
                                      backgroundColor: 'grey.100', 
                                      borderRadius: { xs: 2, sm: 1 },
                                      border: '1px solid',
                                      borderColor: 'grey.300'
                                    }}>
                                      <Typography variant="subtitle2" sx={{ fontWeight: 700, color: 'text.primary' }}>
                                        {dateRangeKey}
                                      </Typography>
                                    </Box>
                                    {/* Customer Header */}
                                    <Box sx={{ 
                                      display: 'flex', 
                                      flexDirection: { xs: 'column', sm: 'row' },
                                      justifyContent: 'space-between', 
                                      alignItems: { xs: 'flex-start', sm: 'center' }, 
                                      mb: { xs: 2, sm: 0.5 }, 
                                      p: { xs: 1.5, sm: 0.5 }, 
                                      backgroundColor: 'primary.50', 
                                      borderRadius: { xs: 2, sm: 1 },
                                      gap: { xs: 1, sm: 0 }
                                    }}>
                                      <Typography variant="h6" sx={{ 
                                        fontWeight: 700, 
                                        color: 'primary.main',
                                        fontSize: { xs: '1.2rem', sm: '1rem' }
                                      }}>
                                        {customerName}
                                      </Typography>
                                      
                                      {/* Trip Summary - Mobile Responsive */}
                                      <Box sx={{ 
                                        display: 'flex', 
                                        flexDirection: { xs: 'column', sm: 'row' },
                                        alignItems: { xs: 'flex-start', sm: 'center' }, 
                                        gap: { xs: 0.5, sm: 1 } 
                                      }}>
                                        <Typography variant="body2" color="text.secondary" sx={{ 
                                          fontSize: { xs: '0.9rem', sm: '0.85rem' },
                                          lineHeight: { xs: 1.4, sm: 1.2 }
                                        }}>
                                          คนขับ: {(() => {
                                            if (list[0]?.vehicle) {
                                              const drivers = getVehicleDrivers(list[0].vehicle.id, list);
                                              return drivers.length > 0 ? drivers.join(', ') : 'ไม่ระบุ';
                                            }
                                            return 'ไม่ระบุ';
                                          })()} | เลขที่: {list[0]?.documentNumber || 'ไม่ระบุ'} | {list.length} เที่ยวรถ | ระยะทางจริง {Math.round(totalActualDist)} กม.
                                        </Typography>
                                        <Typography variant="body2" color="text.secondary" sx={{ 
                                          fontSize: { xs: '0.9rem', sm: '0.85rem' },
                                          display: { xs: 'block', sm: 'inline' }
                                        }}>
                                          ประมาณ {Math.round(totalEstimatedDist)} กม. | ส่วนต่าง {totalAbsoluteDifference >= 0 ? '+' : ''}{Math.round(totalAbsoluteDifference)} กม.
                                        </Typography>
                                        
                                      </Box>
                                    </Box>

                                    {/* Items Summary */}
                                    {rowsForCustomer.length > 0 && (
                                      <Box sx={{ mb: { xs: 2, sm: 0.5 } }}>
                                        <Box sx={{ 
                                          display: 'flex', 
                                          flexDirection: { xs: 'column', sm: 'row' },
                                          alignItems: { xs: 'flex-start', sm: 'center' }, 
                                          flexWrap: 'wrap', 
                                          gap: { xs: 1, sm: 0.5 } 
                                        }}>
                                          <Typography variant="body1" sx={{ 
                                            fontWeight: 600, 
                                            color: 'text.secondary', 
                                            minWidth: 'fit-content',
                                            fontSize: { xs: '1rem', sm: '0.9rem' },
                                            mb: { xs: 0.5, sm: 0 }
                                          }}>
                                            พัสดุ:
                                          </Typography>
                                          
                                          <Box sx={{ 
                                            display: 'flex', 
                                            flexWrap: 'wrap', 
                                            gap: { xs: 1, sm: 0.5 },
                                            width: { xs: '100%', sm: 'auto' }
                                          }}>
                                            {rowsForCustomer.map((r, idx) => (
                                              <Chip
                                                key={idx}
                                                label={`${r.name} ${Number(r.quantity).toLocaleString('th-TH')}${r.unit || ''} (฿${Math.round(r.totalPrice).toLocaleString('th-TH')})`}
                                                size="small"
                                                variant="outlined"
                                                sx={{ 
                                                  fontSize: { xs: '0.8rem', sm: '0.75rem' },
                                                  height: { xs: 'auto', sm: '24px' },
                                                  '& .MuiChip-label': {
                                                    px: { xs: 1.5, sm: 1 },
                                                    py: { xs: 0.5, sm: 0.25 }
                                                  }
                                                }}
                                              />
                                            ))}
                                          </Box>
                                          
                                          <Typography variant="body1" sx={{ 
                                            fontWeight: 700, 
                                            color: 'success.main', 
                                            ml: { xs: 0, sm: 'auto' },
                                            fontSize: { xs: '1.1rem', sm: '0.9rem' },
                                            mt: { xs: 0.5, sm: 0 }
                                          }}>
                                            = ฿{Math.round(sub).toLocaleString('th-TH')}
                                          </Typography>
                                        </Box>

                                        {/* Financial Summary - Mobile Enhanced */}
                                        <Box sx={{ 
                                          mt: { xs: 2, sm: 1 }, 
                                          display: 'flex', 
                                          flexDirection: { xs: 'column', sm: 'row' },
                                          flexWrap: 'wrap', 
                                          gap: { xs: 1.5, sm: 2 }, 
                                          alignItems: { xs: 'flex-start', sm: 'center' }
                                        }}>
                                          <Box sx={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: 1,
                                            p: { xs: 1.5, sm: 1 },
                                            bgcolor: { xs: 'success.50', sm: 'transparent' },
                                            borderRadius: { xs: 2, sm: 0 },
                                            border: { xs: '1px solid', sm: 'none' },
                                            borderColor: { xs: 'success.200', sm: 'transparent' },
                                            minWidth: { xs: '100%', sm: 'auto' }
                                          }}>
                                            <Typography variant="body1" sx={{ 
                                              fontWeight: 500,
                                              color: 'success.main',
                                              fontSize: { xs: '1rem', sm: '0.9rem' }
                                            }}>
                                              เบี้ยเลี้ยง:
                                            </Typography>
                                            <Typography variant="h6" sx={{ 
                                              fontWeight: 700,
                                              color: 'success.main',
                                              fontSize: { xs: '1.2rem', sm: '1rem' }
                                            }}>
                                              ฿{Math.round(totalAllowance).toLocaleString('th-TH')}
                                            </Typography>
                                          </Box>
                                          
                                          {(() => {
                                            const otherCosts = [
                                              { label: 'เช็คระยะ', total: totalDistanceCheckFee },
                                              { label: 'น้ำมัน', total: totalFuelCost },
                                              { label: 'ทางด่วน', total: totalTollFee },
                                              { label: 'ซ่อมแซม', total: totalRepairCost }
                                            ].filter(cost => cost.total > 0);
                                            
                                            const totalOtherCostsSum = otherCosts.reduce((sum, cost) => sum + cost.total, 0);
                                            
                                            return totalOtherCostsSum > 0 ? (
                                              <Box sx={{
                                                display: 'flex',
                                                flexDirection: { xs: 'column', sm: 'row' },
                                                alignItems: { xs: 'flex-start', sm: 'center' },
                                                gap: { xs: 1, sm: 0.5 },
                                                p: { xs: 1.5, sm: 1 },
                                                bgcolor: { xs: 'warning.50', sm: 'transparent' },
                                                borderRadius: { xs: 2, sm: 0 },
                                                border: { xs: '1px solid', sm: 'none' },
                                                borderColor: { xs: 'warning.200', sm: 'transparent' },
                                                minWidth: { xs: '100%', sm: 'auto' }
                                              }}>
                                                <Typography variant="body1" sx={{ 
                                                  fontWeight: 500, 
                                                  color: 'warning.main',
                                                  fontSize: { xs: '1rem', sm: '0.9rem' }
                                                }}>
                                                  ค่าใช้จ่ายอื่นๆ: 
                                                  <Typography component="span" sx={{ 
                                                    fontWeight: 700,
                                                    ml: 0.5,
                                                    fontSize: { xs: '1.1rem', sm: '1rem' }
                                                  }}>
                                                    ฿{Math.round(totalOtherCostsSum).toLocaleString('th-TH')}
                                                  </Typography>
                                                </Typography>
                                                <Typography variant="body2" sx={{ 
                                                  color: 'text.secondary', 
                                                  fontSize: { xs: '0.9rem', sm: '0.85rem' }
                                                }}>
                                                  ({otherCosts.map(cost => `${cost.label} ฿${Math.round(cost.total).toLocaleString('th-TH')}`).join(', ')})
                                                </Typography>
                                              </Box>
                                            ) : (
                                              <Typography variant="body2" sx={{ 
                                                fontWeight: 500, 
                                                color: 'text.secondary',
                                                fontSize: { xs: '0.9rem', sm: '0.85rem' }
                                              }}>
                                                ค่าใช้จ่ายอื่นๆ: <strong>฿0</strong>
                                              </Typography>
                                            );
                                          })()}
                                        </Box>
                                      </Box>
                                    )}

                                    {/* Trip Details - Remarks Only (if any) */}
                                    {(() => {
                                      const tripsWithRemarks = list.filter(trip => trip.remark && trip.remark.trim());
                                      return tripsWithRemarks.length > 0 ? (
                                        <Accordion sx={{ 
                                          boxShadow: 'none', 
                                          '&:before': { display: 'none' }, 
                                          mt: { xs: 1, sm: 0.5 },
                                          bgcolor: { xs: 'grey.25', sm: 'transparent' },
                                          borderRadius: { xs: 2, sm: 0 }
                                        }}>
                                          <AccordionSummary 
                                            expandIcon={<ExpandMoreIcon />} 
                                            sx={{ 
                                              minHeight: { xs: '40px', sm: '32px' }, 
                                              py: { xs: 1, sm: 0.5 }, 
                                              '& .MuiAccordionSummary-content': { 
                                                margin: { xs: '8px 0', sm: '4px 0' }
                                              }
                                            }}
                                          >
                                            <Typography variant="body2" sx={{ 
                                              color: 'text.secondary',
                                              fontSize: { xs: '0.9rem', sm: '0.85rem' }
                                            }}>
                                              หมายเหตุเพิ่มเติม ({tripsWithRemarks.length} รายการ)
                                            </Typography>
                                          </AccordionSummary>
                                          <AccordionDetails sx={{ pt: 0, pb: { xs: 1, sm: 0.5 } }}>
                                            {tripsWithRemarks.map((trip) => (
                                              <Box key={trip.id} sx={{ 
                                                py: { xs: 1, sm: 0.5 }, 
                                                mb: { xs: 1, sm: 0.5 }, 
                                                backgroundColor: { xs: 'white', sm: 'grey.25' }, 
                                                borderRadius: { xs: 2, sm: 1 }, 
                                                px: { xs: 1.5, sm: 0.75 },
                                                border: { xs: '1px solid', sm: 'none' },
                                                borderColor: { xs: 'grey.200', sm: 'transparent' }
                                              }}>
                                                <Typography variant="body2" sx={{ 
                                                  fontStyle: 'italic', 
                                                  color: 'text.secondary', 
                                                  mt: { xs: 0, sm: 0.5 },
                                                  fontSize: { xs: '0.9rem', sm: '0.85rem' },
                                                  lineHeight: { xs: 1.5, sm: 1.3 }
                                                }}>
                                                  {formatDate(trip.departureDate)}: {trip.remark}
                                                </Typography>
                                              </Box>
                                            ))}
                                          </AccordionDetails>
                                        </Accordion>
                                      ) : null;
                                    })()}
                                  </Paper>
                                );
                              });
                            })}
                            </>
                          );
                        })()}
                      </Box>
                    )}
                    
                  </Paper>
                );
              })
            ) : (
              // แสดงข้อมูลรถเดียว
              !isMobile ? (
                <Box>
                  <Typography variant="h6" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                    <DirectionsCarIcon color="primary" />
                    รายละเอียดการเดินทางรถคันที่เลือก
                  </Typography>
                  
                  {/* Use the same customer grouping layout as all vehicles */}
                  <Box>
                    {(() => {
                      const dateGroups = groupCustomersByDateRange(tripRecords);
                      const itemsAll = aggregateItemsByCustomer(tripRecords);
                      
                      return (
                        <>
                          {Object.keys(dateGroups).sort().map((dateRangeKey) => {
                            const customerGroups = dateGroups[dateRangeKey];
                            
                            return Object.keys(customerGroups).map((customerKey) => {
                              const customerName = customerKey.split('::')[1] || 'ไม่ระบุลูกค้า';
                              const list = customerGroups[customerKey];
                              const rowsForCustomer = itemsAll.filter(r => r.customerId === parseInt(customerKey.split('::')[0] || '0'));
                              const sub = rowsForCustomer.reduce((s, r) => s + (r.totalPrice || 0), 0);
                              
                              // Calculate customer totals
                              const totalActualDist = list.reduce((sum, trip) => {
                                const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                                return sum + actualDist;
                              }, 0);
                              const totalEstimatedDist = list.reduce((sum, trip) => {
                                const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                return sum + estimatedDist;
                              }, 0);
                              const totalAllowance = list.reduce((sum, trip) => sum + (typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance), 0);
                              const totalDistanceCheckFee = list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0);
                              const totalFuelCost = list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0);
                              const totalTollFee = list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0);
                              const totalRepairCost = list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0);
                              const totalOtherCosts = totalDistanceCheckFee + totalFuelCost + totalTollFee + totalRepairCost;
                              // Calculate total signed difference by summing individual trip differences with sign
                              const totalAbsoluteDifference = list.reduce((sum, trip) => {
                                const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                                const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                                return sum + (actualDist - estimatedDist);
                              }, 0);
                              
                              return (
                                <Paper key={`${dateRangeKey}-${customerKey}`} sx={{ p: 1, mb: 1, borderRadius: 0, border: '1px solid', borderColor: 'grey.200' }}>
                                  {/* Date Range Header single car */}
                                  <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 0.5, p: 0.5, backgroundColor: 'grey.100', borderRadius: 1 }}>
                                    <Typography variant="caption" sx={{ fontWeight: 500, color: 'text.primary', fontSize: '0.85rem' }}>
                                        {dateRangeKey}
                                      </Typography>
                                      <Typography variant="caption" sx={{ fontWeight: 500, color: 'text.primary', fontSize: '0.85rem' }}>
                                        เลขที่: {list[0]?.documentNumber || 'ไม่ระบุ'}
                                      </Typography>
                                  </Box>
                                  {/* Customer Header - Compact */}
                                  <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 0.5, p: 0.5, backgroundColor: 'primary.50', borderRadius: 1 }}>
                                    <Typography variant="subtitle1" sx={{ fontWeight: 700, color: 'primary.main' }}>
                                      {customerName}
                                    </Typography>
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                    <Typography variant="caption" color="text.secondary" sx={{ fontSize: '0.85rem' }}>
                                      {list.length} เที่ยวรถ | ระยะทางจริง {Math.round(totalActualDist)} กม. | ระยะทางประมาณ {Math.round(totalEstimatedDist)} กม. | ส่วนต่าง {totalAbsoluteDifference >= 0 ? '+' : ''}{Math.round(totalAbsoluteDifference)} กม.
                                    </Typography>
                                    
                                  </Box>
                                </Box>

                                {/* Items Summary - Inline */}
                                {rowsForCustomer.length > 0 && (
                                  <Box sx={{ mb: 0.5 }}>
                                    <Box sx={{ display: 'flex', alignItems: 'center', flexWrap: 'wrap', gap: 0.5 }}>
                                      <Typography variant="body2" sx={{ fontWeight: 600, color: 'text.secondary', minWidth: 'fit-content' }}>
                                        พัสดุ:
                                      </Typography>
                                      {rowsForCustomer.map((r, idx) => (
                                        <Chip
                                          key={idx}
                                          label={`${r.name} ${Number(r.quantity).toLocaleString('th-TH')}${r.unit || ''} (฿${Math.round(r.totalPrice).toLocaleString('th-TH')})`}
                                          size="small"
                                          variant="outlined"
                                          sx={{ fontSize: '0.75rem' }}
                                        />
                                      ))}
                                      <Typography variant="body2" sx={{ fontWeight: 700, color: 'success.main', ml: 'auto' }}>
                                        = ฿{Math.round(sub).toLocaleString('th-TH')}
                                      </Typography>
                                    </Box>

                                    {/* Allowance and Other Costs Summary */}
                                    <Box sx={{ mt: 1, display: 'flex', flexWrap: 'wrap', gap: 2, alignItems: 'center' }}>
                                      <Typography variant="body2" sx={{ fontWeight: 500, color: 'success.main' }}>
                                        เบี้ยเลี้ยง: <strong>฿{Math.round(totalAllowance).toLocaleString('th-TH')}</strong>
                                      </Typography>
                                      {(() => {
                                        const otherCosts = [
                                          { label: 'เช็คระยะ', total: totalDistanceCheckFee },
                                          { label: 'น้ำมัน', total: totalFuelCost },
                                          { label: 'ทางด่วน', total: totalTollFee },
                                          { label: 'ซ่อมแซม', total: totalRepairCost }
                                        ].filter(cost => cost.total > 0);
                                        
                                        const totalOtherCostsSum = otherCosts.reduce((sum, cost) => sum + cost.total, 0);
                                        
                                        return totalOtherCostsSum > 0 ? (
                                          <Typography variant="body2" sx={{ fontWeight: 500, color: 'warning.main' }}>
                                            ค่าใช้จ่ายอื่นๆ: <strong>฿{Math.round(totalOtherCostsSum).toLocaleString('th-TH')}</strong>
                                            <Typography component="span" sx={{ color: 'text.secondary', fontSize: '0.85rem', ml: 0.5 }}>
                                              ({otherCosts.map(cost => `${cost.label} ฿${Math.round(cost.total).toLocaleString('th-TH')}`).join(', ')})
                                            </Typography>
                                          </Typography>
                                        ) : (
                                          <Typography variant="body2" sx={{ fontWeight: 500, color: 'text.secondary' }}>
                                            ค่าใช้จ่ายอื่นๆ: <strong>฿0</strong>
                                          </Typography>
                                        );
                                      })()}
                                    </Box>
                                  </Box>
                                )}

                                {/* Trip Details - Remarks Only (if any) */}
                                {(() => {
                                  const tripsWithRemarks = list.filter(trip => trip.remark && trip.remark.trim());
                                  return tripsWithRemarks.length > 0 ? (
                                    <Accordion sx={{ boxShadow: 'none', '&:before': { display: 'none' }, mt: 0.5 }}>
                                      <AccordionSummary expandIcon={<ExpandMoreIcon />} sx={{ minHeight: '32px', py: 0.5, '& .MuiAccordionSummary-content': { margin: '4px 0' } }}>
                                        <Typography variant="body2" sx={{ color: 'text.secondary' }}>
                                          หมายเหตุเพิ่มเติม ({tripsWithRemarks.length} รายการ)
                                        </Typography>
                                      </AccordionSummary>
                                      <AccordionDetails sx={{ pt: 0, pb: 0.5 }}>
                                        {tripsWithRemarks.map((trip) => (
                                          <Box key={trip.id} sx={{ py: 0.5, mb: 0.5, backgroundColor: 'grey.25', borderRadius: 1, px: 0.75 }}>
                                            <Typography variant="body2" sx={{ fontStyle: 'italic', color: 'text.secondary', mt: 0.5 }}>
                                              {formatDate(trip.departureDate)}: {trip.remark}
                                            </Typography>
                                          </Box>
                                        ))}
                                      </AccordionDetails>
                                    </Accordion>
                                  ) : null;
                                })()}
                              </Paper>
                            );
                          });
                        })}
                        </>
                      );
                    })()}
                  </Box>
                </Box>
              ) : (
                /* Mobile Cards for Single Vehicle */
                <Box>
                  <Typography variant="h6" sx={{ 
                    mb: { xs: 3, sm: 2 }, 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: 1,
                    fontSize: { xs: '1.3rem', sm: '1.25rem' }
                  }}>
                    <DirectionsCarIcon color="primary" />
                    รายละเอียดการเดินทาง
                  </Typography>
                  
                  {/* Use the same customer grouping layout as all vehicles mobile */}
                  <Box sx={{ 
                    display: 'flex', 
                    flexDirection: 'column', 
                    gap: { xs: 3, sm: 2 },
                    px: { xs: 1, sm: 0 }
                  }}>
                    {(() => {
                      const dateGroups = groupCustomersByDateRange(tripRecords);
                      const itemsAll = aggregateItemsByCustomer(tripRecords);
                      
                      return (
                        <>
                          {Object.keys(dateGroups).sort().map((dateRangeKey) => {
                            const customerGroups = dateGroups[dateRangeKey];
                            
                            return Object.keys(customerGroups).map((customerKey) => {
                              const customerName = customerKey.split('::')[1] || 'ไม่ระบุลูกค้า';
                              const list = customerGroups[customerKey];
                              const rowsForCustomer = itemsAll.filter(r => r.customerId === parseInt(customerKey.split('::')[0] || '0'));
                              const sub = rowsForCustomer.reduce((s, r) => s + (r.totalPrice || 0), 0);
                            
                            // Calculate customer totals
                            const totalActualDist = list.reduce((sum, trip) => {
                              const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance;
                              return sum + actualDist;
                            }, 0);
                            const totalEstimatedDist = list.reduce((sum, trip) => {
                              const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                              return sum + estimatedDist;
                            }, 0);
                            const totalAllowance = list.reduce((sum, trip) => sum + (typeof trip.totalAllowance === 'string' ? parseFloat(trip.totalAllowance) || 0 : trip.totalAllowance), 0);
                            const totalDistanceCheckFee = list.reduce((sum, trip) => sum + (typeof trip.distanceCheckFee === 'string' ? parseFloat(trip.distanceCheckFee) || 0 : trip.distanceCheckFee || 0), 0);
                            const totalFuelCost = list.reduce((sum, trip) => sum + (typeof trip.fuelCost === 'string' ? parseFloat(trip.fuelCost) || 0 : trip.fuelCost || 0), 0);
                            const totalTollFee = list.reduce((sum, trip) => sum + (typeof trip.tollFee === 'string' ? parseFloat(trip.tollFee) || 0 : trip.tollFee || 0), 0);
                            const totalRepairCost = list.reduce((sum, trip) => sum + (typeof trip.repairCost === 'string' ? parseFloat(trip.repairCost) || 0 : trip.repairCost || 0), 0);
                            // Calculate total signed difference by summing individual trip differences with sign
                            const totalAbsoluteDifference = list.reduce((sum, trip) => {
                              const actualDist = typeof trip.actualDistance === 'string' ? parseFloat(trip.actualDistance) || 0 : trip.actualDistance || 0;
                              const estimatedDist = typeof trip.estimatedDistance === 'string' ? parseFloat(trip.estimatedDistance) || 0 : trip.estimatedDistance || 0;
                              return sum + (actualDist - estimatedDist);
                            }, 0);
                            
                            return (
                              <Paper key={`${dateRangeKey}-${customerKey}`} sx={{
                                p: { xs: 3, sm: 2.5 },
                                borderRadius: { xs: 4, sm: 3 },
                                boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
                                border: '1px solid rgba(0,0,0,0.05)',
                                '&:hover': {
                                  boxShadow: '0 6px 20px rgba(0,0,0,0.12)',
                                  transform: 'translateY(-2px)'
                                },
                                transition: 'all 0.3s ease'
                              }}>
                                {/* Date Range Header - Mobile */}
                                <Box sx={{ 
                                  mb: { xs: 2, sm: 1 }, 
                                  p: { xs: 1.5, sm: 1 }, 
                                  backgroundColor: 'grey.100', 
                                  borderRadius: { xs: 3, sm: 2 },
                                  border: '1px solid',
                                  borderColor: 'grey.300',
                                  textAlign: 'center'
                                }}>
                                  <Typography variant="subtitle2" sx={{ fontWeight: 500, color: 'text.primary', fontSize: { xs: '1.5rem'} }}>
                                    {dateRangeKey}
                                  </Typography>
                                </Box>
                                {/* Customer Header - Mobile */}
                                <Box sx={{ 
                                  mb: { xs: 3, sm: 2 }, 
                                  p: { xs: 2, sm: 1.5 }, 
                                  backgroundColor: 'primary.50', 
                                  borderRadius: { xs: 3, sm: 2 },
                                  border: '1px solid',
                                  borderColor: 'primary.200'
                                }}>
                                  <Typography variant="h5" sx={{ 
                                    fontWeight: 700, 
                                    color: 'primary.main', 
                                    mb: { xs: 2, sm: 1 },
                                    fontSize: { xs: '1.4rem', sm: '1.25rem' }
                                  }}>
                                    {customerName}
                                  </Typography>
                                  <Box sx={{ display: 'flex', flexDirection: 'column', gap: { xs: 1.5, sm: 1 } }}>
                                    <Typography variant="body1" color="text.secondary" sx={{
                                      fontSize: { xs: '1rem', sm: '0.9rem' }
                                    }}>
                                      จำนวนเที่ยวรถ: <strong>{list.length} เที่ยวรถ</strong>
                                    </Typography>
                                    <Typography variant="body1" color="text.secondary" sx={{
                                      fontSize: { xs: '1rem', sm: '0.9rem' }
                                    }}>
                                      ระยะทางจริง: <strong>{Math.round(totalActualDist)} กม.</strong>
                                    </Typography>
                                    <Typography variant="body1" color="text.secondary" sx={{
                                      fontSize: { xs: '1rem', sm: '0.9rem' }
                                    }}>
                                      ระยะทางประมาณ: <strong>{Math.round(totalEstimatedDist)} กม.</strong>
                                    </Typography>
                                    <Typography 
                                      variant="body1" 
                                      sx={{ 
                                        color: 'text.primary',
                                        fontWeight: 600,
                                        fontSize: { xs: '1rem', sm: '0.9rem' }
                                      }}
                                    >
                                      ส่วนต่าง: <strong>{totalAbsoluteDifference >= 0 ? '+' : ''}{Math.round(totalAbsoluteDifference)} กม.</strong>
                                    </Typography>
                                  </Box>
                                </Box>

                                {/* Items Summary - Mobile */}
                                {rowsForCustomer.length > 0 && (
                                  <Box sx={{ 
                                    mb: { xs: 3, sm: 2 }, 
                                    p: { xs: 2.5, sm: 2 }, 
                                    backgroundColor: 'grey.50', 
                                    borderRadius: { xs: 3, sm: 2 },
                                    border: '1px solid',
                                    borderColor: 'grey.200'
                                  }}>
                                    <Typography variant="h6" sx={{ 
                                      fontWeight: 600, 
                                      color: 'text.primary', 
                                      mb: { xs: 2, sm: 1.5 },
                                      fontSize: { xs: '1.2rem', sm: '1.1rem' }
                                    }}>
                                      พัสดุที่ขนส่ง:
                                    </Typography>
                                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: { xs: 2, sm: 1.5 } }}>
                                      {rowsForCustomer.map((r, idx) => (
                                        <Box key={idx} sx={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between', 
                                          alignItems: 'center',
                                          p: { xs: 2, sm: 1.5 },
                                          backgroundColor: 'white',
                                          borderRadius: { xs: 2, sm: 1 },
                                          border: '1px solid',
                                          borderColor: 'grey.300'
                                        }}>
                                          <Typography variant="body1" sx={{
                                            fontSize: { xs: '1rem', sm: '0.9rem' }
                                          }}>
                                            {r.name} {Number(r.quantity).toLocaleString('th-TH')}{r.unit || ''}
                                          </Typography>
                                          <Typography variant="h6" sx={{ 
                                            fontWeight: 600, 
                                            color: 'success.main',
                                            fontSize: { xs: '1.1rem', sm: '1rem' }
                                          }}>
                                            ฿{Math.round(r.totalPrice).toLocaleString('th-TH')}
                                          </Typography>
                                        </Box>
                                      ))}
                                      <Box sx={{ 
                                        borderTop: '1px solid', 
                                        borderColor: 'grey.300', 
                                        pt: { xs: 2, sm: 1.5 }, 
                                        mt: { xs: 1, sm: 0.5 } 
                                      }}>
                                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                          <Typography variant="h6" sx={{ 
                                            fontWeight: 700,
                                            fontSize: { xs: '1.2rem', sm: '1.1rem' }
                                          }}>
                                            รวมค่าพัสดุ:
                                          </Typography>
                                          <Typography variant="h5" sx={{ 
                                            fontWeight: 700, 
                                            color: 'success.main',
                                            fontSize: { xs: '1.4rem', sm: '1.3rem' }
                                          }}>
                                            ฿{Math.round(sub).toLocaleString('th-TH')}
                                          </Typography>
                                        </Box>
                                      </Box>
                                    </Box>
                                  </Box>
                                )}

                                {/* Financial Summary - Mobile */}
                                <Box sx={{ 
                                  mb: { xs: 3, sm: 2 }, 
                                  p: { xs: 2.5, sm: 2 }, 
                                  backgroundColor: 'warning.50', 
                                  borderRadius: { xs: 3, sm: 2 },
                                  border: '1px solid',
                                  borderColor: 'warning.200'
                                }}>
                                  <Typography variant="h6" sx={{ 
                                    fontWeight: 600, 
                                    color: 'text.primary', 
                                    mb: { xs: 2, sm: 1.5 },
                                    fontSize: { xs: '1.2rem', sm: '1.1rem' }
                                  }}>
                                    สรุปค่าใช้จ่าย:
                                  </Typography>
                                  <Box sx={{ display: 'flex', flexDirection: 'column', gap: { xs: 2, sm: 1.5 } }}>
                                    <Box sx={{ 
                                      display: 'flex', 
                                      justifyContent: 'space-between', 
                                      alignItems: 'center',
                                      p: { xs: 2, sm: 1.5 },
                                      backgroundColor: 'success.50',
                                      borderRadius: { xs: 2, sm: 1 },
                                      border: '1px solid',
                                      borderColor: 'success.200'
                                    }}>
                                      <Typography variant="body1" sx={{
                                        fontSize: { xs: '1rem', sm: '0.9rem' }
                                      }}>
                                        เบี้ยเลี้ยง:
                                      </Typography>
                                      <Typography variant="h6" sx={{ 
                                        fontWeight: 600, 
                                        color: 'success.main',
                                        fontSize: { xs: '1.1rem', sm: '1rem' }
                                      }}>
                                        ฿{Math.round(totalAllowance).toLocaleString('th-TH')}
                                      </Typography>
                                    </Box>
                                    
                                    {totalDistanceCheckFee > 0 && (
                                      <Box sx={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        p: { xs: 2, sm: 1.5 },
                                        backgroundColor: 'warning.100',
                                        borderRadius: { xs: 2, sm: 1 },
                                        border: '1px solid',
                                        borderColor: 'warning.300'
                                      }}>
                                        <Typography variant="body1" sx={{
                                          fontSize: { xs: '1rem', sm: '0.9rem' }
                                        }}>
                                          ค่าเช็คระยะ:
                                        </Typography>
                                        <Typography variant="h6" sx={{ 
                                          fontWeight: 600, 
                                          color: 'warning.main',
                                          fontSize: { xs: '1.1rem', sm: '1rem' }
                                        }}>
                                          ฿{Math.round(totalDistanceCheckFee).toLocaleString('th-TH')}
                                        </Typography>
                                      </Box>
                                    )}
                                    
                                    {totalFuelCost > 0 && (
                                      <Box sx={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        p: { xs: 2, sm: 1.5 },
                                        backgroundColor: 'info.50',
                                        borderRadius: { xs: 2, sm: 1 },
                                        border: '1px solid',
                                        borderColor: 'info.200'
                                      }}>
                                        <Typography variant="body1" sx={{
                                          fontSize: { xs: '1rem', sm: '0.9rem' }
                                        }}>
                                          ค่าน้ำมัน:
                                        </Typography>
                                        <Typography variant="h6" sx={{ 
                                          fontWeight: 600, 
                                          color: 'info.main',
                                          fontSize: { xs: '1.1rem', sm: '1rem' }
                                        }}>
                                          ฿{Math.round(totalFuelCost).toLocaleString('th-TH')}
                                        </Typography>
                                      </Box>
                                    )}
                                    
                                    {totalTollFee > 0 && (
                                      <Box sx={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        p: { xs: 2, sm: 1.5 },
                                        backgroundColor: 'secondary.50',
                                        borderRadius: { xs: 2, sm: 1 },
                                        border: '1px solid',
                                        borderColor: 'secondary.200'
                                      }}>
                                        <Typography variant="body1" sx={{
                                          fontSize: { xs: '1rem', sm: '0.9rem' }
                                        }}>
                                          ค่าทางด่วน:
                                        </Typography>
                                        <Typography variant="h6" sx={{ 
                                          fontWeight: 600, 
                                          color: 'secondary.main',
                                          fontSize: { xs: '1.1rem', sm: '1rem' }
                                        }}>
                                          ฿{Math.round(totalTollFee).toLocaleString('th-TH')}
                                        </Typography>
                                      </Box>
                                    )}
                                    
                                    {totalRepairCost > 0 && (
                                      <Box sx={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        p: { xs: 2, sm: 1.5 },
                                        backgroundColor: 'error.50',
                                        borderRadius: { xs: 2, sm: 1 },
                                        border: '1px solid',
                                        borderColor: 'error.200'
                                      }}>
                                        <Typography variant="body1" sx={{
                                          fontSize: { xs: '1rem', sm: '0.9rem' }
                                        }}>
                                          ค่าซ่อมแซม:
                                        </Typography>
                                        <Typography variant="h6" sx={{ 
                                          fontWeight: 600, 
                                          color: 'error.main',
                                          fontSize: { xs: '1.1rem', sm: '1rem' }
                                        }}>
                                          ฿{Math.round(totalRepairCost).toLocaleString('th-TH')}
                                        </Typography>
                                      </Box>
                                    )}
                                  </Box>
                                </Box>

                                {/* Trip Details - Remarks Only (if any) */}
                                {(() => {
                                  const tripsWithRemarks = list.filter(trip => trip.remark && trip.remark.trim());
                                  return tripsWithRemarks.length > 0 ? (
                                    <Accordion sx={{ boxShadow: 'none', '&:before': { display: 'none' } }}>
                                      <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                                        <Typography variant="body1" sx={{ 
                                          color: 'text.secondary',
                                          fontSize: { xs: '1rem', sm: '0.9rem' }
                                        }}>
                                          หมายเหตุเพิ่มเติม ({tripsWithRemarks.length} รายการ)
                                        </Typography>
                                      </AccordionSummary>
                                      <AccordionDetails>
                                        {tripsWithRemarks.map((trip) => (
                                          <Box key={trip.id} sx={{ 
                                            py: { xs: 2, sm: 1.5 }, 
                                            mb: { xs: 2, sm: 1.5 }, 
                                            backgroundColor: 'grey.25', 
                                            borderRadius: { xs: 2, sm: 1 }, 
                                            px: { xs: 2, sm: 1.5 } 
                                          }}>
                                            <Typography variant="body2" color="text.secondary" sx={{ 
                                              fontWeight: 600,
                                              fontSize: { xs: '0.9rem', sm: '0.8rem' }
                                            }}>
                                              {formatDate(trip.departureDate)}:
                                            </Typography>
                                            <Typography variant="body1" sx={{ 
                                              fontStyle: 'italic', 
                                              color: 'text.secondary', 
                                              mt: { xs: 1, sm: 0.5 },
                                              fontSize: { xs: '1rem', sm: '0.9rem' }
                                            }}>
                                              {trip.remark}
                                            </Typography>
                                          </Box>
                                        ))}
                                      </AccordionDetails>
                                    </Accordion>
                                  ) : null;
                                })()}
                              </Paper>
                            );
                          });
                        })}
                        </>
                      );
                    })()}
                  </Box>
                </Box>
              )
            )}

           
          </Box>
        )}
      </Box>
    </Layout>
    </LocalizationProvider>
  );
}


